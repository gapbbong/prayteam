/**
 * âœ… ê¸°ë„ê·¸ë£¹ ê´€ë¦¬ìš© GAS (ê·¸ë£¹ID = ì‹œíŠ¸ì´ë¦„ êµ¬ì¡°)
 * - mode=login â†’ ê´€ë¦¬ìê³„ì • ì‹œíŠ¸ì—ì„œ í™•ì¸
 * - mode=signup â†’ ìƒˆ ê³„ì • ì¶”ê°€
 * - ê·¸ë£¹ID, ê·¸ë£¹ëª…ì€ "ê·¸ë£¹ì •ë³´" ì‹œíŠ¸ì—ì„œë§Œ ê´€ë¦¬
 * - ê° ê·¸ë£¹IDê°€ ê³§ ì‹œíŠ¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë¨ (ì˜ˆ: XL8IXTvhrRoknAKgQ1Gs)
 */

function doGet(e) {
  const mode = e.parameter.mode || "";

  let output;
  switch (mode) {
    case "login": output = handleLogin(e); break;
    case "signup": output = handleSignup(e); break;
    case "getGroups": output = handleGetGroups(e); break;
    case "getGroupById": output = handleGetGroupById(e); break;
    case "getPrayers": output = handleGetPrayers(e); break;
    case "getPrayersAll": output = handleGetPrayersAll(e); break;
    case "getSubs": output = handleGetSubs(e); break;
    default:
      output = ContentService.createTextOutput("Invalid request")
        .setMimeType(ContentService.MimeType.TEXT);
  }

  // ğŸ”¥ [ìµœì í™” 2] í´ë¼ì´ì–¸íŠ¸ ìºì‹œ ë°©ì§€ í—¤ë” ì¶”ê°€
  // ì¹´í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ë“±ì—ì„œ ì´ì „ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ë¬¸ì œ í•´ê²°
  try {
    if (output && typeof output.getMimeType === 'function' && output.getMimeType() === ContentService.MimeType.JSON) {
      return output
        .setHeader('Cache-Control', 'no-cache, no-store, must-revalidate')
        .setHeader('Pragma', 'no-cache')
        .setHeader('Expires', '0');
    }
  } catch (e) {
    // setHeader ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° ê·¸ëƒ¥ ë°˜í™˜
  }
  return output;
}

// âœ… CORS preflight ìš”ì²­ ì²˜ë¦¬ (OPTIONS ë©”ì„œë“œ)
function doOptions(e) {
  return ContentService
    .createTextOutput("")
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type')
    .setHeader('Access-Control-Max-Age', '86400');
}


function doPost(e) {
  Logger.log("=== ğŸ“© doPost í˜¸ì¶œë¨ ===");

  if (!e) {
    Logger.log("âš  e ê°ì²´ ì—†ìŒ");
    return jsonOutput({ error: "no event object" });
  }

  let mode = e.parameter.mode || "";
  let data = {};

  if (e.postData && e.postData.contents) {
    try {
      data = JSON.parse(e.postData.contents);
    } catch (err) {
      Logger.log("âŒ JSON íŒŒì‹± ì‹¤íŒ¨: " + err);
    }
  }

  if (!mode && data.mode) {
    mode = data.mode;
  }

  switch (mode) {
    case "renameGroup": return handleRenameGroup(e);
    case "deleteGroup": return handleDeleteGroup(e);
    case "savePrayer": return handleSavePrayer(data);
    case "addMember": return handleAddMember(data);
    case "addGroup": return handleAddGroup(e);
    case "saveNote": return handleSaveNote(e);
    case "saveSub": return handleSaveSub(e);
    case "renameMember": return handleRenameMember(data);
    case "addSharedGroup": return handleAddSharedGroup(e);
    case "addLog": return handleAddLog(e);
    case "logStay": return handleLogStay(e);

    default:
      return jsonOutput({ error: "invalid mode", received: mode });
  }
}

/* -------------------------------------------------------------------------- */
/* âœ… ê·¸ë£¹, ë©¤ë²„, ë¡œê·¸ì¸, íšŒì›ê°€ì…                                            */
/* -------------------------------------------------------------------------- */

function handleLogin(e) {
  const id = e.parameter.id || "";
  const pwd = e.parameter.pwd || "";
  const sheet = getOrCreateSheet("ê´€ë¦¬ìê³„ì •");

  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const idCol = headers.indexOf("ê´€ë¦¬ìID");
  const pwdCol = headers.indexOf("ë¹„ë°€ë²ˆí˜¸");

  const found = data.find(r => r[idCol] === id && String(r[pwdCol]) === String(pwd));
  if (!found) return jsonOutput({ success: false, message: "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜" });

  return jsonOutput({ success: true, message: "ë¡œê·¸ì¸ ì„±ê³µ" });
}

function handleSignup(e) {
  const id = e.parameter.id || "";
  const pwd = e.parameter.pwd || "";
  const email = e.parameter.email || "";
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê´€ë¦¬ìê³„ì •");
  if (!sheet) return jsonOutput({ success: false, message: "ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  const idCol = headers.indexOf("ê´€ë¦¬ìID");
  const emailCol = headers.indexOf("ì´ë©”ì¼");

  if (data.some(r => r[idCol] === id)) {
    return jsonOutput({ success: false, message: "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." });
  }

  if (email && data.some(r => r[emailCol] === email)) {
    return jsonOutput({ success: false, message: "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤." });
  }

  const joinedAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");
  sheet.appendRow([id, pwd, joinedAt, email]);
  return jsonOutput({ success: true, message: "íšŒì›ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤." });
}

function handleGetGroups(e) {
  const adminId = e.parameter.adminId || "";
  const sheet = getOrCreateSheet("ê·¸ë£¹ì •ë³´");
  
  // ë°ì´í„°ê°€ ì ì„ ë• ì „ì²´ ë¡œë“œí•´ë„ ë¬´ë°©í•˜ì§€ë§Œ, ë§ì•„ì§€ë©´ ìµœì í™” í•„ìš”
  // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
  const rows = sheet.getDataRange().getValues();
  if (rows.length < 1) return jsonOutput({ groups: [] });

  const headers = rows[0];
  const idxAdmin = headers.indexOf("ê´€ë¦¬ìID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");
  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  // ì •ê·œí™” ë¯¸ë¦¬ ìˆ˜í–‰
  const targetAdminId = adminId.normalize("NFKC").replace(/\s+/g, "");

  const groups = rows.slice(1)
    .filter(r => 
      String(r[idxAdmin]).normalize("NFKC").replace(/\s+/g, "") === targetAdminId
    )
    .map(r => {
      const members = memberCols
        .map(i => String(r[i] || "").trim())
        .filter(v => v !== "");

      return {
        ê´€ë¦¬ìID: r[idxAdmin],
        ê·¸ë£¹ëª…: r[idxGroupName],
        ê·¸ë£¹ID: r[idxGroupId],
        êµ¬ì„±ì›ìˆ˜: r[idxCount],
        êµ¬ì„±ì›ëª©ë¡: members
      };
    });

  return jsonOutput({ groups });
}

function handleGetGroupById(e) {
  const groupId = e.parameter.groupId || "";
  const sheet = getOrCreateSheet("ê·¸ë£¹ì •ë³´");
  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  const row = rows.find(r => r[idxGroupId] === groupId);
  if (!row) return jsonOutput({ error: "group not found" });

  const members = memberCols
    .map(i => String(row[i] || "").trim())
    .filter(v => v !== "");

  return jsonOutput({
    group: {
      ê·¸ë£¹ID: row[idxGroupId],
      ê·¸ë£¹ëª…: row[idxGroupName],
      êµ¬ì„±ì›ëª©ë¡: members,
    },
  });
}

/* -------------------------------------------------------------------------- */
/* âœ… ê¸°ë„ì œëª© ì €ì¥ ë° ì¡°íšŒ                                                   */
/* -------------------------------------------------------------------------- */

function handleSavePrayer(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = data.groupId;
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = ss.insertSheet(sheetName);

  const lastCol = sheet.getLastColumn();
  const headers = sheet.getLastRow() === 0
    ? createPrayerHeaders(sheet, 6)
    : sheet.getRange(1, 1, 1, lastCol).getValues()[0];

  const maxCols = (headers.length - 4) / 3;
  const needed = Math.max(data.prayers.length, maxCols);

  // ì»¬ëŸ¼ ë¶€ì¡± ì‹œ í™•ì¥
  if (needed > maxCols) {
    const newHeaders = [];
    for (let i = maxCols + 1; i <= needed; i++) {
      newHeaders.push(`ê¸°ë„ì œëª©${i}`, `R${i}`, `C${i}`);
    }
    // í•œë²ˆì— í—¤ë” ì¶”ê°€
    sheet.getRange(1, lastCol + 1, 1, newHeaders.length).setValues([newHeaders]);
  }

  const now = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy.MM.dd a h:mm:ss");
  const prayerCells = [];
  for (let i = 0; i < needed; i++) prayerCells.push(data.prayers[i] || "", "", "");
  const row = [data.groupName, data.groupId, data.member, now, ...prayerCells];
  
  sheet.appendRow(row);

  // ğŸ”¥ [ìµœì í™” 1] í‘¸ì‹œ ì•Œë¦¼ ë¹„ë™ê¸° ì²˜ë¦¬ (íŠ¸ë¦¬ê±° í™œìš©)
  // UrlFetchApp.fetchê°€ ë™ê¸°ì ì´ë¼ ë°œìƒí•˜ëŠ” 2~5ì´ˆ ë”œë ˆì´ ì œê±°
  try {
    const payload = {
      groupId: data.groupId,
      title: `${data.member}ë‹˜ì´ ìƒˆë¡œìš´ ê¸°ë„ì œëª©ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.`,
      message: data.prayers[0] || "(ë‚´ìš© ì—†ìŒ)"
    };
    
    // PropertiesServiceì— ì•Œë¦¼ ë°ì´í„° ì„ì‹œ ì €ì¥ (í ì—­í• )
    // ì—¬ëŸ¬ ê±´ì´ ë™ì‹œì— ë“¤ì–´ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë°°ì—´ë¡œ ê´€ë¦¬í•˜ë©´ ì¢‹ìœ¼ë‚˜, 
    // ê°„ë‹¨í•˜ê²Œ ë®ì–´ì“°ê¸° ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ í‚¤ ì‚¬ìš©
    const key = 'NOTI_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    PropertiesService.getScriptProperties().setProperty(key, JSON.stringify(payload));
    
    // 1ì´ˆ í›„ ì‹¤í–‰ë˜ëŠ” íŠ¸ë¦¬ê±° ìƒì„± (ë¹„ë™ê¸° íš¨ê³¼)
    ScriptApp.newTrigger('asyncSendNotification')
      .timeBased()
      .after(100) // 0.1ì´ˆ í›„ (ìµœì†Œ ëŒ€ê¸°)
      .create();
      
  } catch (e) {
    Logger.log("ì•Œë¦¼ íŠ¸ë¦¬ê±° ìƒì„± ì‹¤íŒ¨: " + e);
    // íŠ¸ë¦¬ê±° ì‹¤íŒ¨ ì‹œ ê·¸ëƒ¥ ë„˜ì–´ê° (ì‚¬ìš©ì ê²½í—˜ ìš°ì„ )
  }

  return jsonOutput({ success: true, message: "ì €ì¥ ì™„ë£Œ", time: now });
}

// ğŸ”¥ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë  ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
function asyncSendNotification() {
  const props = PropertiesService.getScriptProperties();
  const keys = props.getKeys().filter(k => k.startsWith('NOTI_'));
  
  if (keys.length === 0) return;

  // ì €ì¥ëœ ëª¨ë“  ì•Œë¦¼ ì²˜ë¦¬
  keys.forEach(key => {
    const payloadJson = props.getProperty(key);
    if (!payloadJson) return;
    
    try {
      UrlFetchApp.fetch("https://prayteam.creat1324.com/.netlify/functions/notify", {
        method: "post",
        contentType: "application/json",
        payload: payloadJson,
        muteHttpExceptions: true // ì—ëŸ¬ ë°œìƒí•´ë„ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨ ì•ˆ í•¨
      });
    } catch (e) {
      Logger.log("ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜: " + e);
    }
    
    // ì²˜ë¦¬ í›„ ì‚­ì œ
    props.deleteProperty(key);
  });

  // ì™„ë£Œëœ íŠ¸ë¦¬ê±° ì •ë¦¬ (ì²­ì†Œ)
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => {
    if (t.getHandlerFunction() === 'asyncSendNotification') {
      ScriptApp.deleteTrigger(t);
    }
  });
}

function createPrayerHeaders(sheet, count) {
  const headers = ["ê·¸ë£¹ëª…", "ê·¸ë£¹ID", "ë©¤ë²„ì´ë¦„", "ì‘ì„±ì‹œê°„"];
  for (let i = 1; i <= count; i++) headers.push(`ê¸°ë„ì œëª©${i}`, `R${i}`, `C${i}`);
  sheet.appendRow(headers);
  return headers;
}

function handleGetPrayers(e) {
  const groupId = e.parameter.groupId || "";
  const member = e.parameter.member || "";
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(groupId);
  if (!sheet) return jsonOutput({});

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return jsonOutput({});

  // ğŸ”¥ [ìµœì í™” 3] ìµœì‹  í–‰ ê²€ìƒ‰ ë²”ìœ„ ì œí•œ
  // ì „ì²´ ë°ì´í„°ë¥¼ ì½ì§€ ì•Šê³  ìµœê·¼ 100í–‰ë§Œ ì½ì–´ì„œ ê²€ìƒ‰ ì†ë„ í–¥ìƒ
  const CHECK_ROWS = 100;
  const startRow = Math.max(2, lastRow - CHECK_ROWS + 1);
  const numRows = lastRow - startRow + 1;
  
  // í•„ìš”í•œ ë²”ìœ„ë§Œ ë¡œë“œ
  const dataRange = sheet.getRange(startRow, 1, numRows, sheet.getLastColumn());
  const data = dataRange.getValues();
  
  // í—¤ë”ëŠ” ë³„ë„ë¡œ ì½ìŒ (í•­ìƒ 1í–‰)
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const memberCol = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const timeCol = headers.indexOf("ì‘ì„±ì‹œê°„");

  const prayerCols = [];
  const rCols = [];
  const cCols = [];

  headers.forEach((h, i) => {
    if (typeof h !== "string") return;
    if (h.startsWith("ê¸°ë„ì œëª©")) {
      prayerCols.push(i);
    } else if (/^R\d+$/.test(h)) {
      rCols.push(i);
    } else if (/^C\d+$/.test(h)) {
      cCols.push(i);
    }
  });

  // ë¡œë“œí•œ ë°ì´í„°(data) ë‚´ì—ì„œ ì—­ìˆœ ê²€ìƒ‰
  // data[0]ì´ startRowì— í•´ë‹¹í•¨
  for (let i = data.length - 1; i >= 0; i--) {
    const row = data[i];
    if (String(row[memberCol]).trim() === member) {
      const prayers = prayerCols.map(idx => row[idx] || "").filter(v => v !== "");
      const responses = rCols.map(idx => row[idx] || "");
      const comments = cCols.map(idx => row[idx] || "");

      return jsonOutput({
        groupId,
        member,
        prayers,
        responses,
        comments,
        time: row[timeCol]
      });
    }
  }

  return jsonOutput({});
}

function handleGetPrayersAll(e) {
  const groupId = e.parameter.groupId || "";
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(groupId);
  if (!sheet) return jsonOutput([]);

  // ì „ì²´ ëª©ë¡ ì¡°íšŒëŠ” ì–´ì©” ìˆ˜ ì—†ì´ ì „ì²´ë¥¼ ì½ì–´ì•¼ í•  ìˆ˜ ìˆìŒ
  // í•˜ì§€ë§Œ ì—¬ê¸°ë„ ìºì‹±ì„ ì ìš©í•˜ê±°ë‚˜ í˜ì´ì§•ì„ í•  ìˆ˜ ìˆìŒ (ì¼ë‹¨ ìœ ì§€)
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return jsonOutput([]);

  const headers = data.shift().map(String);
  const idxGroup = headers.indexOf("ê·¸ë£¹ëª…");
  const idxMember = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const idxTime = headers.indexOf("ì‘ì„±ì‹œê°„");
  const prayerCols = headers.map((h, i) => h.startsWith("ê¸°ë„ì œëª©") ? i : -1).filter(i => i !== -1);

  const latest = {};
  for (let i = data.length - 1; i >= 0; i--) {
    const row = data[i];
    const member = row[idxMember];
    if (!member || latest[member]) continue;
    latest[member] = {
      ê·¸ë£¹ëª…: row[idxGroup],
      ë©¤ë²„ì´ë¦„: member,
      prayers: prayerCols
  .map(idx => row[idx])
  .filter(v => v !== null && v !== undefined && String(v).trim() !== ""),
      ì‘ì„±ì‹œê°„: row[idxTime],
    };
  }
  return jsonOutput(Object.values(latest));
}

/* -------------------------------------------------------------------------- */
/* âœ… ë©¤ë²„ ì¶”ê°€                                                               */
/* -------------------------------------------------------------------------- */
function handleAddMember(data) {
  const { groupId, newMember } = data;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter((i) => i !== -1);

  let rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);
  if (rowIndex === -1) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const row = rows[rowIndex];

  const current = memberCols
    .map(i => String(row[i] || "").trim())
    .filter(v => v !== "");

  let finalName = newMember;
  let cnt = 2;
  while (current.includes(finalName)) {
    finalName = newMember + cnt;
    cnt++;
  }

  let targetCol = -1;
  for (const col of memberCols) {
    if (!row[col]) {
      targetCol = col;
      break;
    }
  }

  if (targetCol === -1) {
    targetCol = sheet.getLastColumn();
    const newHeader = `êµ¬ì„±ì›${memberCols.length + 1}`;
    sheet.getRange(1, targetCol + 1).setValue(newHeader);
  }

  sheet.getRange(rowIndex + 1, targetCol + 1).setValue(finalName);
  sheet.getRange(rowIndex + 1, idxCount + 1).setValue(current.length + 1);

  return jsonOutput({
    success: true,
    message: `${finalName} ì¶”ê°€ ì™„ë£Œ`,
    count: current.length + 1,
  });
}

/* -------------------------------------------------------------------------- */
function getOrCreateSheet(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let s = ss.getSheetByName(name);
  if (!s) s = ss.insertSheet(name);
  return s;
}

function jsonOutput(obj) {
  // ê¸°ë³¸ JSON ì¶œë ¥ (í—¤ë”ëŠ” doGetì—ì„œ ì¶”ê°€ë¨)
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleRenameMember(data) {
  const { groupId, oldName, newName } = data;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const groupSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!groupSheet) return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

  const rows = groupSheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);
  if (rowIndex === -1) {
    return jsonOutput({ success: false, message: "í•´ë‹¹ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const row = rows[rowIndex];

  let replaced = false;
  memberCols.forEach(col => {
    if (String(row[col]).trim() === oldName) {
      groupSheet.getRange(rowIndex + 1, col + 1).setValue(newName);
      replaced = true;
    }
  });

  if (!replaced) {
    return jsonOutput({ success: false, message: "ê¸°ì¡´ ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." });
  }

  const prayerSheet = ss.getSheetByName(groupId);
  if (prayerSheet) {
    const dataRows = prayerSheet.getDataRange().getValues();
    const headers2 = dataRows[0];
    const idxMember = headers2.indexOf("ë©¤ë²„ì´ë¦„");

    for (let i = 1; i < dataRows.length; i++) {
      if (String(dataRows[i][idxMember]).trim() === oldName) {
        prayerSheet.getRange(i + 1, idxMember + 1).setValue(newName);
      }
    }
  }

  return jsonOutput({
    success: true,
    message: `'${oldName}' â†’ '${newName}' ì´ë¦„ ìˆ˜ì • ì™„ë£Œ`
  });
}

function handleRenameGroup(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const groupId = body.groupId;
  const newName = body.newName;

  if (!groupId || !newName) {
    return jsonOutput({ success: false, message: "groupId ë˜ëŠ” newName ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");

  if (!sheet) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");
  const idxName = headers.indexOf("ê·¸ë£¹ëª…");

  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);

  if (rowIndex === -1) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  sheet.getRange(rowIndex + 1, idxName + 1).setValue(newName);

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ëª…ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
  });
}

function handleDeleteGroup(e) {
  let data = {};
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    Logger.log("âŒ JSON íŒŒì‹± ì‹¤íŒ¨: " + err);
  }

  const groupId = data.groupId;

  if (!groupId) {
    return jsonOutput({ success: false, message: "groupIdê°€ ì—†ìŠµë‹ˆë‹¤." });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const infoSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!infoSheet) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const rows = infoSheet.getDataRange().getValues();
  const headers = rows[0];
  const idxID = headers.indexOf("ê·¸ë£¹ID");

  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);

  if (rowIndex !== -1) infoSheet.deleteRow(rowIndex + 1);

  const prayerSheet = ss.getSheetByName(groupId);
  if (prayerSheet) {
    ss.deleteSheet(prayerSheet);
  }

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ì´ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
  });
}

function handleSaveNote(e) {
  const body = JSON.parse(e.postData.contents);
  const { groupId, member, index, answer, comment } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(groupId);
  if (!sheet) return jsonOutput({ success: false, message: "sheet ì—†ìŒ" });

  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const idxMember = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const idxR = headers.indexOf(`R${index}`);
  const idxC = headers.indexOf(`C${index}`);

  let target = -1;
  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][idxMember]).trim() === member) {
      target = i + 1;
      break;
    }
  }

  if (target === -1) {
    return jsonOutput({ success: false, message: "ì €ì¥ëœ ê¸°ë„ì œëª© ì—†ìŒ" });
  }

  sheet.getRange(target, idxR + 1).setValue(answer || "");
  sheet.getRange(target, idxC + 1).setValue(comment || "");

  return jsonOutput({ success: true });
}

function handleAddGroup(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { adminId, groupName, members } = body;

  if (!adminId || !groupName || !members || members.length === 0) {
    return jsonOutput({ success: false, message: "í•„ìˆ˜ í•­ëª© ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´") || ss.insertSheet("ê·¸ë£¹ì •ë³´");

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxAdmin     = headers.indexOf("ê´€ë¦¬ìID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");
  const idxGroupId   = headers.indexOf("ê·¸ë£¹ID");
  const idxCreated   = headers.indexOf("ìƒì„±ì¼");
  const idxCount     = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜" ? i : -1))
    .filter(i => i !== -1);

  const newGroupId = "G" + Math.random().toString(36).substring(2, 14);
  const createdAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");

  while (members.length > memberCols.length) {
    const nextIndex = memberCols.length + 1;
    sheet.getRange(1, sheet.getLastColumn() + 1).setValue("êµ¬ì„±ì›" + nextIndex);
    memberCols.push(sheet.getLastColumn() - 1);
  }

  const newRow = new Array(headers.length).fill("");

  newRow[idxAdmin]     = adminId;
  newRow[idxGroupName] = groupName;
  newRow[idxGroupId]   = newGroupId;
  newRow[idxCreated]   = createdAt;
  newRow[idxCount]     = members.length;

  members.forEach((m, i) => {
    const col = memberCols[i];
    newRow[col] = m;
  });

  sheet.appendRow(newRow);

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ ì¶”ê°€ ì™„ë£Œ",
    groupId: newGroupId,
    createdAt
  });
}

function handleAddSharedGroup(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { adminId, groupId } = body;

  if (!adminId || !groupId) {
    return jsonOutput({ success: false, message: "í•„ìˆ˜ ê°’ ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const infoSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!infoSheet) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ ì—†ìŒ" });
  }

  const rows = infoSheet.getDataRange().getValues();
  const headers = rows[0];
  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  const source = rows.find(r => r[idxGroupId] === groupId);
  if (!source) {
    return jsonOutput({ success: false, message: "ì›ë³¸ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const groupName = source[idxGroupName];

  const members = memberCols
    .map(i => String(source[i] || "").trim())
    .filter(v => v !== "");

  const newGroupId = "G" + Math.random().toString(36).substring(2, 14);
  const createdAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");

  const idxAdmin  = headers.indexOf("ê´€ë¦¬ìID");
  const idxCreated = headers.indexOf("ìƒì„±ì¼");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  const newRow = new Array(headers.length).fill("");

  newRow[idxAdmin] = adminId;
  newRow[idxGroupName] = groupName + " (ê³µìœ )";
  newRow[idxGroupId] = newGroupId;
  newRow[idxCreated] = createdAt;
  newRow[idxCount] = members.length;

  members.forEach((m, i) => {
    const col = memberCols[i];
    newRow[col] = m;
  });

  infoSheet.appendRow(newRow);

  return jsonOutput({
    success: true,
    message: "ê³µìœ  ê·¸ë£¹ì´ ë‚´ ê·¸ë£¹ìœ¼ë¡œ ë³µì œ ì™„ë£Œ",
    groupId: newGroupId
  });
}

function handleAddLog(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { page, adminId, groupId, member, from, device, browser } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ë°©ë¬¸ë¡œê·¸") || ss.insertSheet("ë°©ë¬¸ë¡œê·¸");

  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      "ë‚ ì§œ","ì‹œê°„","í˜ì´ì§€","adminId","groupId","member",
      "from","device","browser","ì²´ë¥˜ì´ˆ"
    ]);
  }

  const now = new Date();
  const dateStr = Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd");
  const timeStr = Utilities.formatDate(now, "Asia/Seoul", "HH:mm:ss");

  sheet.appendRow([
    dateStr, timeStr, page || "", adminId || "", groupId || "",
    member || "", from || "", device || "", browser || "", ""
  ]);

  return jsonOutput({ success: true });
}

function handleLogStay(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { page, groupId, stay, time } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ë°©ë¬¸ë¡œê·¸") || ss.insertSheet("ë°©ë¬¸ë¡œê·¸");

  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      "ë‚ ì§œ","ì‹œê°„","í˜ì´ì§€","adminId","groupId","member",
      "from","device","browser","ì²´ë¥˜ì´ˆ"
    ]);
  }

  const dateObj = new Date(time);
  const dateStr = Utilities.formatDate(dateObj, "Asia/Seoul", "yyyy-MM-dd");
  const timeStr = Utilities.formatDate(dateObj, "Asia/Seoul", "HH:mm:ss");

  sheet.appendRow([
    dateStr, timeStr, page || "", "", groupId || "",
    "", "", "", "", stay || 0
  ]);

  return jsonOutput({ success: true });
}

/* -------------------------------------------------------------------------- */
/* âœ… í‘¸ì‹œ ì•Œë¦¼ êµ¬ë… ê´€ë¦¬ (pushSubs)                                           */
/* -------------------------------------------------------------------------- */

function handleSaveSub(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { groupId, subscription } = body;
  if (!groupId || !subscription) {
    return jsonOutput({ success: false, message: "í•„ìˆ˜ ê°’ ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("pushSubs");
  if (!sheet) {
    sheet = ss.insertSheet("pushSubs");
    sheet.appendRow(["ì‹œê°„", "ê·¸ë£¹ID", "ì—”ë“œí¬ì¸íŠ¸", "êµ¬ë…JSON"]);
  }

  const now = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");
  const endpoint = subscription.endpoint;
  const subJson = JSON.stringify(subscription);

  // ì¤‘ë³µ ì²´í¬ (ì—”ë“œí¬ì¸íŠ¸ + ê·¸ë£¹ID)
  // ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ì„±ëŠ¥ ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìµœê·¼ ë°ì´í„°ë§Œ ì²´í¬í•˜ê±°ë‚˜ ë³„ë„ ë¡œì§ í•„ìš”
  // ì—¬ê¸°ì„œëŠ” ì „ì²´ ìŠ¤ìº” ëŒ€ì‹  appendë§Œ í•˜ê³ , ë°œì†¡ ì‹œ ì¤‘ë³µ ì œê±°í•˜ëŠ” ë°©ì‹ë„ ê°€ëŠ¥í•˜ì§€ë§Œ
  // ì‹œíŠ¸ í¬ê¸° ê´€ë¦¬ë¥¼ ìœ„í•´ ì¤‘ë³µ ê°±ì‹ ìœ¼ë¡œ ì²˜ë¦¬
  
  const lastRow = sheet.getLastRow();
  let foundRow = -1;
  
  if (lastRow > 1) {
    // ìµœì‹  1000ê°œë§Œ ì²´í¬ (ì„±ëŠ¥ íƒ€í˜‘)
    const checkCount = Math.min(lastRow - 1, 1000);
    const startRow = lastRow - checkCount + 1;
    const data = sheet.getRange(startRow, 1, checkCount, 4).getValues();
    
    // ì—­ìˆœ ê²€ìƒ‰ (ìµœì‹  ë°ì´í„° ìš°ì„ )
    for (let i = data.length - 1; i >= 0; i--) {
      // data[i][1] = ê·¸ë£¹ID, data[i][2] = ì—”ë“œí¬ì¸íŠ¸
      if (data[i][2] === endpoint && data[i][1] === groupId) {
        foundRow = startRow + i;
        break;
      }
    }
  }

  if (foundRow !== -1) {
    // ì—…ë°ì´íŠ¸
    sheet.getRange(foundRow, 1).setValue(now);
    sheet.getRange(foundRow, 4).setValue(subJson);
    return jsonOutput({ success: true, message: "êµ¬ë… ê°±ì‹  ì™„ë£Œ" });
  } else {
    // ì¶”ê°€
    sheet.appendRow([now, groupId, endpoint, subJson]);
    return jsonOutput({ success: true, message: "êµ¬ë… ì €ì¥ ì™„ë£Œ" });
  }
}

function handleGetSubs(e) {
  const groupId = e.parameter.groupId;
  if (!groupId) return jsonOutput([]);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("pushSubs");
  if (!sheet) return jsonOutput([]);

  const rows = sheet.getDataRange().getValues();
  if (rows.length < 2) return jsonOutput([]);

  const idxGroupId = 1; // Bì—´
  const idxJson = 3;    // Dì—´

  const subs = rows.slice(1)
    .filter(r => r[idxGroupId] === groupId)
    .map(r => {
      try {
        return JSON.parse(r[idxJson]);
      } catch (err) {
        return null;
      }
    })
    .filter(s => s !== null);

  return jsonOutput(subs);
}

<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

  <title>ê¸°ë„ ì‘ë‹µ ë…¸íŠ¸</title>
  <script src="/app-config.js"></script>

  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #1c1f3a, #0d0e16);
      --text-bright: #ffffff;
      --text-dim: #cccccc;
      --accent-gold: #ffdf6b;
      --blue: #4f9cff;
      --blue-dark: #367de3;

      --ans-yellow: #ffdf6b;
      --ans-blue: #4f9cff;
      --ans-orange: #ff8f3d;
      --ans-purple: #b490ff;

      --card-bg: rgba(255, 255, 255, 0.07);
      --border-light: rgba(255, 255, 255, 0.2);
      --shadow: 0 4px 14px rgba(0, 0, 0, 0.4);
      --radius: 14px;
    }

    body {
      font-family: "Noto Sans KR", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-bright);
      margin: 0;
      padding: 18px;
      min-height: 100vh;
    }

    /* ìƒë‹¨ë°” */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar h2 {
      flex: 1;
      text-align: center;
      color: var(--accent-gold);
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--accent-gold);
      font-size: 24px;
      padding: 6px;
      cursor: pointer;
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }

    .prayer-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--accent-gold);
    }

    .prayer-text {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.5;
      margin-bottom: 12px;
      color: #eee;
      white-space: pre-line;
    }

    /* ì‘ë‹µ ë²„íŠ¼ */
    .btn-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .ans-btn {
      flex: 1;
      padding: 9px;
      border-radius: 10px;
      background: #2a2a3a;
      color: #ddd;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: 0.15s;
      font-family: inherit;
    }

    .ans-btn.active {
      color: #000;
      transform: scale(0.97);
      font-weight: 700;
    }

    .ans-btn[data-type="ì‘ë‹µë¨"].active {
      background: var(--ans-yellow);
    }

    .ans-btn[data-type="ê¸°ëŒ€ì¤‘"].active {
      background: var(--ans-blue);
    }

    .ans-btn[data-type="ê±°ì ˆí•˜ì‹¬"].active {
      background: var(--ans-orange);
    }

    .ans-btn[data-type="ë‹¤ë¥¸ë°©í–¥"].active {
      background: var(--ans-purple);
    }

    /* ì½”ë©˜íŠ¸ */
    .textarea {
      width: 100%;
      padding: 4px;
      min-height: 10px !important;
      /* ì´ˆê¸° ë†’ì´ ì¤„ì„ */
      max-height: 300px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: #1e1e2d;
      color: #fff;
      font-size: 15px;
      resize: none;
      margin-bottom: 6px;
      line-height: 1.4;
      overflow-y: hidden;
      font-family: inherit;
      /* ë³¸ë¬¸ì´ë‘ ê°™ì€ ê¸€ê¼´ */
    }

    /* ì´ˆê¸°í™” / ì €ì¥ ë²„íŠ¼ ì˜ì—­ */
    .btn-area {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .reset-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      background: #555;
      color: #ddd;
      border: none;
      font-size: 15px;
      font-family: inherit;
    }

    .save-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      background: #888;
      /* â† ì´ˆê¸° íšŒìƒ‰ */
      border: none;
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: not-allowed;
      /* â† ë¹„í™œì„±í™” */
      opacity: 0.4;
      /* â† íë¦¬ê²Œ */
      font-family: inherit;
      transition: 0.15s;
    }

    .save-btn.active {
      background: var(--blue);
      /* â† í™œì„±í™” ì‹œ íŒŒë€ìƒ‰ */
      cursor: pointer;
      opacity: 1;
    }

    .save-btn.saving {
      background: var(--blue-dark);
    }

    /* í•„í„° ëª¨ë‹¬ (ê°„ë‹¨ ìŠ¤íƒ€ì¼) */
    .filter-modal {
      display: none;
      /* â† ê°•ì œ ë¹„í‘œì‹œ */
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      /* â† ë°˜ë“œì‹œ ìµœìƒë‹¨ìœ¼ë¡œ */
    }

    .filter-box {
      background: #fff;
      color: #000;
      padding: 18px;
      border-radius: 14px;
      width: 70%;
      max-width: 320px;
    }

    .filter-item {
      padding: 8px 4px;
      border-bottom: 1px solid #ddd;
      font-size: 16px;
      cursor: pointer;
    }

    .filter-item:last-child {
      border-bottom: none;
    }

    .prayer-text::before {
      content: "âœ”";
      color: #FFD54F;
      /* ë…¸ë€ìƒ‰ ì²´í¬ */
      font-weight: 900;
      margin-right: 6px;
    }
  </style>
</head>

<body>

  <div class="top-bar">
    <button class="icon-btn" onclick="location.href='index.html?fromRecord=1'" style="font-size:16px;">â—€ ë’¤ë¡œ</button>
    <h2 id="title"></h2>
    <button class="icon-btn" onclick="toggleFilter()" style="font-size:16px;">í•„í„°</button>
  </div>

  <div id="list"></div>

  <!-- í•„í„° -->
  <div id="filterModal" class="filter-modal" onclick="toggleFilter()">
    <div class="filter-box" onclick="event.stopPropagation()">
      <div class="filter-item" onclick="setFilter('ì „ì²´')">ì „ì²´ ë³´ê¸°</div>
      <div class="filter-item" onclick="setFilter('ì‘ë‹µë¨')">ì‘ë‹µë¨</div>
      <div class="filter-item" onclick="setFilter('ê¸°ëŒ€ì¤‘')">ê¸°ëŒ€ì¤‘</div>
      <div class="filter-item" onclick="setFilter('ê±°ì ˆí•˜ì‹¬')">ê±°ì ˆí•˜ì‹¬</div>
      <div class="filter-item" onclick="setFilter('ë‹¤ë¥¸ë°©í–¥')">ë‹¤ë¥¸ ë°©í–¥</div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const groupId = params.get("groupId");
    const groupName = params.get("groupName");
    const member = params.get("member");

    document.getElementById("title").textContent = `${groupName} - ${member}`;

    let prayerIndices = []; // [NEW] ì‹¤ì œ ì»¬ëŸ¼ ë²ˆí˜¸ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

    // ì´ˆê¸° ë¡œë“œ
    loadNotes();

    // ë’¤ë¡œê°€ê¸° ë°©ì§€ ë° ì œì–´ (ë°±ìŠ¤í˜ì´ìŠ¤ ë“±)
    // íˆìŠ¤í† ë¦¬ ê´€ë¦¬ (í•´ì‹œ ê¸°ë°˜)
    if (typeof window !== 'undefined') {
      // í˜„ì¬ í˜ì´ì§€ ì§„ì… ì‹œ í•´ì‹œê°€ ì—†ìœ¼ë©´ #notes ì¶”ê°€
      if (!window.location.hash) {
        window.history.replaceState({ step: 'base' }, "", window.location.href + "#base");
        window.history.pushState({ step: 'notes' }, "", window.location.href + "#notes");
      }

      window.onpopstate = function (event) {
        // ì‚¬ìš©ìê°€ ë’¤ë¡œê°€ê¸°ë¥¼ ëˆŒëŸ¬ #base ìƒíƒœë¡œ ëŒì•„ì˜¤ë©´ index.htmlë¡œ ë³´ëƒ„
        if (!window.location.hash || window.location.hash === '#base') {
          location.href = "index.html?fromRecord=1";
        }
      };
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Backspace") {
        const tag = e.target.tagName.toLowerCase();
        const isEditable = e.target.isContentEditable || tag === "input" || tag === "textarea";
        if (!isEditable) {
          e.preventDefault();
          // ë°±ìŠ¤í˜ì´ìŠ¤ ì‹œì—ë„ ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ì‹¤í–‰ -> onpopstateê°€ ì²˜ë¦¬í•¨
          window.history.back();
        }
      }
    });

    // -------------------------------
    // ê¸°ë„ì œëª© + R/C ì½ì–´ì„œ ë Œë”
    // -------------------------------
    function loadNotes() {
      fetch(`${CONFIG.GAS_URL}?mode=getPrayers&groupId=${encodeURIComponent(groupId)}&member=${encodeURIComponent(member)}`)
        .then(res => res.json())
        .then(data => {
          const prayers = data.prayers || [];
          const responses = data.responses || [];
          const comments = data.comments || [];
          const dates = data.dates || [];
          const visibilities = data.visibilities || [];
          prayerIndices = data.indices || []; // [NEW]

          renderList(prayers, responses, comments, dates, visibilities);
        });
    }

    // -------------------------------
    // UI ë Œë”ë§
    // -------------------------------
    function renderList(prayers, responses, comments, dates, visibilities) {
      const wrap = document.getElementById("list");
      wrap.innerHTML = "";

      prayers.forEach((text, idx) => {
        const index = idx + 1;
        const savedR = responses[idx] || "";
        const savedC = comments[idx] || "";
        const savedD = dates[idx] || "";
        const savedV = visibilities[idx] || "";

        // [ì¤‘ìš”] ìˆ¨ê¹€(Hidden) ì²˜ë¦¬ëœ í•­ëª©ì€ ë Œë”ë§ì—ì„œ ì œì™¸
        if (savedV === 'Hidden') return;

        // í•„í„° ì ìš©
        if (currentFilter !== "ì „ì²´" && savedR !== currentFilter) {
          return;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.id = `card-${index}`;

        card.innerHTML = `
	<div class="prayer-title" id="date-${index}" style="font-size: 13px; color: #aaa; margin-bottom: 4px;"></div>
	<div class="prayer-text"> ${text || ""}</div>
      <div class="view-status" id="status-${index}" style="font-size: 11px; margin-bottom: 8px; color: #4f9cff;"></div>
      <div class="btn-row" id="ans-row-${index}">
        ${makeAnsButton("ì‘ë‹µë¨", index)}
        ${makeAnsButton("ê¸°ëŒ€ì¤‘", index)}
        ${makeAnsButton("ê±°ì ˆí•˜ì‹¬", index)}
        ${makeAnsButton("ë‹¤ë¥¸ë°©í–¥", index)}
      </div>

      <textarea class="textarea" id="cmt-${index}"
        placeholder="ì½”ë©˜íŠ¸ ì…ë ¥..."></textarea>

      <div class="btn-area">
        <button class="reset-btn" onclick="resetNote(${index})" style="flex: 0.6; font-size: 13px;">ì´ˆê¸°í™”</button>
        <button class="reset-btn" onclick="archiveNote(${index})" style="flex: 0.6; font-size: 13px; background: #3c3c4a;">ë³´ê´€</button>
        <button class="save-btn" id="save-${index}" onclick="saveNote(${index})">ì €ì¥</button>
      </div>
    `;

        wrap.appendChild(card);

        // ë‚ ì§œ í‘œì‹œ
        if (savedD) {
          document.getElementById(`date-${index}`).textContent = `ğŸ“… ${savedD}`;
        }

        // ì €ì¥ë˜ì–´ ìˆë˜ ì‘ë‹µ/ì½”ë©˜íŠ¸ UIì— ë°˜ì˜
        if (savedR) {
          selectAnswer(index, savedR, true);
        }
        const textarea = document.getElementById(`cmt-${index}`);
        textarea.value = savedC || "";
        autoResize(textarea);
        textarea.addEventListener("input", () => {
          autoResize(textarea);
          updateSaveActive(index);
        });

      });

      if (wrap.innerHTML === "") {
        wrap.innerHTML = `<p style="text-align:center; color:#aaa; margin-top:40px;">í•´ë‹¹ë˜ëŠ” ê¸°ë„ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
      }
    }

    // -------------------------------
    // ì‘ë‹µ ë²„íŠ¼ ìƒì„±/ì„ íƒ
    // -------------------------------
    function makeAnsButton(label, index) {
      return `
    <button class="ans-btn"
      data-type="${label}"
      onclick="selectAnswer(${index}, '${label}')"
      id="ans-${index}-${label}">
      ${label}
    </button>
  `;
    }

    function selectAnswer(index, type, isInitial = false) {
      const row = document.getElementById(`ans-row-${index}`);
      if (!row) return;

      [...row.children].forEach(btn => btn.classList.remove("active"));
      const btn = document.getElementById(`ans-${index}-${type}`);
      if (btn) btn.classList.add("active");

      if (!isInitial) {
        window[`answer_${index}`] = type;
      }
    }

    // -------------------------------
    // ìë™ ë†’ì´ ì¡°ì ˆ
    // -------------------------------
    function autoResize(el) {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }

    // -------------------------------
    // ì´ˆê¸°í™”
    // -------------------------------
    function resetNote(index) {
      window[`answer_${index}`] = "";
      const cmt = document.getElementById(`cmt-${index}`);
      if (cmt) {
        cmt.value = "";
        autoResize(cmt);
      }

      const row = document.getElementById(`ans-row-${index}`);
      if (row) {
        [...row.children].forEach(btn => btn.classList.remove("active"));
      }
    }

    // -------------------------------
    // ì €ì¥ ê¸°ëŠ¥
    // -------------------------------
    function saveNote(index) {
      const btn = document.getElementById(`save-${index}`);
      btn.classList.add("saving");
      btn.textContent = "ì €ì¥ì¤‘...";

      const answer = window[`answer_${index}`] || "";
      const comment = document.getElementById(`cmt-${index}`).value || "";

      // [ìˆ˜ì •] ë°°ì—´ ìˆœë²ˆ ëŒ€ì‹  ì‹¤ì œ ì‹œíŠ¸ ì»¬ëŸ¼(Slot) ì¸ë±ìŠ¤ ì‚¬ìš©
      const realIndex = prayerIndices[index - 1];

      const body = {
        mode: "saveNote",
        groupId,
        member,
        index: realIndex,
        answer,
        comment
      };

      fetch(CONFIG.GAS_URL, {
        method: "POST",
        body: JSON.stringify(body)
      })
        .then(r => r.json())
        .then(() => {
          btn.textContent = "ì €ì¥ë¨ âœ“";
          setTimeout(() => {
            btn.textContent = "ì €ì¥";
            btn.classList.remove("saving");
          }, 1300);
        });
    }

    // -------------------------------
    // ë³´ê´€(ìˆ¨ê¹€) ê¸°ëŠ¥
    // -------------------------------
    function archiveNote(index) {
      // ê¸€ë¡œë²Œ ë£°ì— ë”°ë¼ ë³„ë„ì˜ í™•ì¸ì°½ ì—†ì´ ì¦‰ì‹œ ë³´ê´€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      const realIndex = prayerIndices[index - 1];
      const body = {
        mode: "saveNote",
        groupId,
        member,
        index: realIndex,
        answer: "ê¸°ëŒ€ì¤‘", // ë³´ê´€ ì‹œ ì‘ë‹µì€ ì´ˆê¸°í™” ê¶Œì¥
        comment: document.getElementById(`cmt-${index}`).value || "",
        visibility: "Hidden"
      };

      fetch(CONFIG.GAS_URL, {
        method: "POST",
        body: JSON.stringify(body)
      })
        .then(r => r.json())
        .then(() => {
          // í™”ë©´ì—ì„œ ì¹´ë“œ ì œê±°
          const card = document.getElementById(`card-${index}`);
          if (card) {
            card.style.opacity = "0";
            card.style.transform = "scale(0.9)";
            setTimeout(() => card.remove(), 300);
          }
        });
    }

    // -------------------------------
    // í•„í„°
    // -------------------------------
    function toggleFilter() {
      const modal = document.getElementById("filterModal");
      modal.style.display = (modal.style.display === "flex") ? "none" : "flex";
    }

    function setFilter(type) {
      currentFilter = type;
      toggleFilter();
      loadNotes();
    }

    function selectAnswer(index, type, isInitial = false) {
      const row = document.getElementById(`ans-row-${index}`);
      if (!row) return;

      [...row.children].forEach(btn => btn.classList.remove("active"));
      const btn = document.getElementById(`ans-${index}-${type}`);
      if (btn) btn.classList.add("active");

      if (!isInitial) {
        window[`answer_${index}`] = type;
        updateSaveActive(index);            // â† ì´ ì¤„ ì¶”ê°€!
      }
    }

    function updateSaveActive(index) {
      const btn = document.getElementById(`save-${index}`);
      const answer = window[`answer_${index}`] || "";
      const comment = document.getElementById(`cmt-${index}`).value.trim();

      if (answer !== "" || comment !== "") {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    }

  </script>

  <div style="text-align: center; margin-top: 30px; padding-bottom: 20px;">
    <span style="font-size: 10px; color: #666; margin-bottom: 2px;">v0.5.5</span>
  </div>

</body>

</html>
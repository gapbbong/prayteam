<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì „ì²´ ê¸°ë„ë¬¸ ë³´ê¸°</title>
  <style>
  body {
  font-family: "Noto Sans KR", sans-serif !important;
}

    body {
      background: linear-gradient(180deg, #1e1e2f, #151522);
      color: #fff;
      font-family: "Pretendard", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #24243b;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    header h1 {
	font-size: clamp(24px, 5vw, 34px);
  font-weight: 700;
      color: #ffdf6b;
      margin: 0;
  text-align: center; /* âœ… ê°€ìš´ë° ì •ë ¬ ì¶”ê°€ */
    }
    header button {
      background: #ff6b6b;
      border: none;
      color: white;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
    }
    main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  max-width: 600px;     /* record.htmlê³¼ ìœ ì‚¬í•œ í­ */
  margin: 0 auto;       /* ê°€ìš´ë° ë°°ì¹˜ */
}

    .prayer-card {
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid rgba(255, 255, 255, 0.18);
  padding: 16px 14px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 4px 14px rgba(255, 255, 255, 0.1);
}

    .prayer-card h3 {
  color: var(--accent-gold);
  margin: 0 0 10px;
  font-size: 20px;
  font-weight: 600;
}

    .prayer-card p {
  font-size: 18px;
  font-weight: 600;
      margin: 0;
      white-space: pre-line;
      line-height: 1.5;
    }
	.prayer-card small {
  display: block;
  text-align: right;
  color: #aaa;
  font-size: 13px;
  margin-top: 6px;
}
/* âœ… ë¡œë”© í† ìŠ¤íŠ¸ */
.toast-loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  color: #ffdf6b;
  padding: 14px 24px;
  border-radius: 10px;
  font-size: clamp(16px, 3vw, 20px);
  display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
  z-index: 1000;
  white-space: nowrap;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  animation: fadeInOut 1s ease-in-out infinite alternate;
}

/* âœ… ì  ì• ë‹ˆë©”ì´ì…˜ */
.toast-loading .dots {
  display: inline-block;
  width: 1em;
  text-align: left;
}

@keyframes fadeInOut {
  from { opacity: 0.8; }
  to { opacity: 1; }
}

@keyframes dotPulse {
  0% { content: ""; }
  25% { content: "."; }
  50% { content: ".."; }
  75% { content: "..."; }
  100% { content: ""; }
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: #24243b;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.home-btn {
  background: none;
  border: none;
  color: #ffdf6b;
  font-size: clamp(22px, 4vw, 30px);
  cursor: pointer;
}

.spacer {
  width: 24px; /* í™ˆ ë²„íŠ¼ í¬ê¸° ë§ì¶”ê¸° ìœ„í•œ ê³µê°„ */
}

/* ì´ë¦„: ë…¸ë€ìƒ‰ */
.member-name {
  color: #ffdf6b !important;
  font-weight: 600;
}

/* (ê·¸ë£¹ëª…): í°ìƒ‰ */
.group-name {
  color: #ffffff !important;
  opacity: 0.85;
  font-weight: 500;
}

  </style>
</head>
<body>
  <header>
  <button class="home-btn" onclick="goHome()">ğŸ </button>
  <h1>ë‚´ ê·¸ë£¹ ì „ì²´ ê¸°ë„ë¬¸</h1>
  <span class="spacer"></span>
</header>


  <main id="prayerList">
    <p>â³ ê¸°ë„ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </main>

  <script>
  // âœ… Netlify proxyë¥¼ í†µí•´ GAS ì ‘ê·¼
  const scriptURL = "/.netlify/functions/proxy";
const container = document.getElementById("prayerList");

let groupIdList = [];

// âœ… localStorage groupIds ì•ˆì •ì ìœ¼ë¡œ ë¡œë“œ + adminId ê¸°ë°˜ ë³µêµ¬
document.addEventListener("DOMContentLoaded", async () => {

  try {
    const saved = localStorage.getItem("groupIds");
    if (saved) {
      groupIdList = JSON.parse(saved);
      console.log("ğŸ“¦ ë¶ˆëŸ¬ì˜¨ groupIds:", groupIdList);
    } else {
      console.warn("âš ï¸ groupIds ì—†ìŒ. adminIdë¡œ ë³µêµ¬ ì‹œë„ ì¤‘...");
      const adminId = localStorage.getItem("adminId");
      if (adminId) {
        const res = await fetch(`${scriptURL}?mode=getGroups&adminId=${adminId}`);
        const data = await res.json();
        if (data.groups?.length) {
          groupIdList = data.groups.map(g => g.ê·¸ë£¹ID);
          localStorage.setItem("groupIds", JSON.stringify(groupIdList));
          console.log("âœ… ë³µêµ¬ëœ groupIds:", groupIdList);
        }
      }
    }
  } catch (err) {
    console.error("ğŸš¨ localStorage ë¡œë“œ ì˜¤ë¥˜:", err);
  }

  // âœ… ë¡œë”© ì™„ë£Œ í›„ ê²°ê³¼ ì²˜ë¦¬
    // âœ… ë³µêµ¬ ì™„ë£Œ í›„ ìµœì¢… í™•ì¸
  if (!groupIdList.length) {
    console.warn("âš ï¸ ë³µêµ¬ í›„ì—ë„ groupIds ì—†ìŒ â€” ë¡œê·¸ì¸ í•„ìš”");
    setTimeout(() => {
      container.innerHTML =
        "<p>âŒ ë¶ˆëŸ¬ì˜¬ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í›„ ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”.</p>";
    }, 500); // âœ… ë³µêµ¬ ì§€ì—° ê³ ë ¤ (0.5ì´ˆ í›„ í‘œì‹œ)
  } else {
    await loadAllPrayers();
  }
});

function formatTimeAgo(isoTime) {
  if (!isoTime) return "ì‘ì„±ì‹œê°„ ì—†ìŒ";

  // âœ… í˜•ì‹ í†µì¼: ë¶ˆí•„ìš”í•œ ê³µë°±/ì /AMPM ë³€í™˜
  const clean = isoTime
    .replace(/\s+/g, " ")
    .replace(/ì˜¤ì „|AM|am/g, "ì˜¤ì „")
    .replace(/ì˜¤í›„|PM|pm/g, "ì˜¤í›„")
    .trim();

  // âœ… ì˜ˆ: "2025. 11. 2. ì˜¤í›„ 10:11:31" ë˜ëŠ” "2025-11-02 ì˜¤í›„ 10:11:31"
  const match = clean.match(
    /(\d{4})[.\s-]*(\d{1,2})[.\s-]*(\d{1,2})[.\s]*(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/
  );

  let past;
  if (match) {
    let [_, y, m, d, ampm, h, min, s = "00"] = match;
    h = Number(h);
    if (ampm === "ì˜¤í›„" && h < 12) h += 12;
    if (ampm === "ì˜¤ì „" && h === 12) h = 0;
    past = new Date(`${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}T${String(h).padStart(2, "0")}:${min}:${s}`);
  } else {
    // âœ… ISO í¬ë§· ("2025-11-03T16:37:40") ì§€ì›
    past = new Date(isoTime);
  }

  if (isNaN(past)) return "ì‹œê°„ ì˜¤ë¥˜";

  const diff = (Date.now() - past.getTime()) / 1000;
  if (diff < 60) return "ë°©ê¸ˆ ì „";
  if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
  if (diff < 2592000) return `${Math.floor(diff / 86400)}ì¼ ì „`;
  return `${Math.floor(diff / 2592000)}ë‹¬ ì „`;
}

  async function loadAllPrayers() {
  const toast = document.getElementById("toastLoading");
  const dots = toast.querySelector(".dots");

  // âœ… í† ìŠ¤íŠ¸ í‘œì‹œ + ì  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  toast.style.display = "flex";
  let dotCount = 0;
  const dotInterval = setInterval(() => {
    dotCount = (dotCount + 1) % 4;
    dots.textContent = ".".repeat(dotCount);
  }, 500);

  container.innerHTML = "";
  if (!groupIdList.length) {
    container.innerHTML = "<p>âŒ ë¶ˆëŸ¬ì˜¬ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í›„ ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”.</p>";
    toast.style.display = "none";
    clearInterval(dotInterval);
    return;
  }

  // âœ… ë³‘ë ¬ fetchë¡œ ëª¨ë“  ê·¸ë£¹ ë™ì‹œì— ìš”ì²­
try {
  const fetchTasks = groupIdList.map(async gid => {
    console.log("â¡ï¸ ìš”ì²­ ì¤‘:", `${scriptURL}?mode=getPrayersAll&groupId=${gid}`);
    const res = await fetch(`${scriptURL}?mode=getPrayersAll&groupId=${gid}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return data.map(item => ({ ...item, ê·¸ë£¹ID: gid }));
  });

  // âœ… ëª¨ë“  ìš”ì²­ ë³‘ë ¬ë¡œ ì²˜ë¦¬
  const results = await Promise.allSettled(fetchTasks);
  const allPrayers = results
    .filter(r => r.status === "fulfilled")
    .flatMap(r => r.value);

  // âœ… ìµœì‹  ì‘ì„±ì‹œê°„ ìˆœ ì •ë ¬
  allPrayers.sort((a, b) => new Date(b.ì‘ì„±ì‹œê°„) - new Date(a.ì‘ì„±ì‹œê°„));

  // âœ… ë Œë”ë§
  container.innerHTML = allPrayers.map(item => `
  <div class="prayer-card">
    <h3>
  <span class="member-name">${item.ë©¤ë²„ì´ë¦„}</span>
  <span class="group-name">(${item.ê·¸ë£¹ëª…})</span>
</h3>

    <p>
  ${ (item.prayers || [])
      .map(p => `Â· ${p}`)      // â† ê°€ìš´ë° ì  ì¶”ê°€
      .join("\n") }
</p>

    <small class="time">${formatTimeAgo(item.ì‘ì„±ì‹œê°„)}</small>
  </div>
`).join("");


} catch (err) {
  console.error("ğŸš¨ ì „ì²´ ìš”ì²­ ì‹¤íŒ¨:", err);
  container.innerHTML = `<p>âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${err.message})</p>`;
}

  // âœ… ëª¨ë“  ê·¸ë£¹ ë¡œë”© ì™„ë£Œ í›„ í† ìŠ¤íŠ¸ ìˆ¨ê¹€
  clearInterval(dotInterval);
  toast.style.display = "none";
}

function goHome() {
  const adminId = localStorage.getItem("adminId");
  if (!adminId) return (window.location.href = "index.html");
  window.location.href = "index.html?fromRecord=1";
}

</script>
<!-- ğŸ”¹ ë¡œë”© í† ìŠ¤íŠ¸ -->
<div id="toastLoading" class="toast-loading">
  â³ ê¸°ë„ì œëª© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘<span class="dots">...</span>
</div>

</body>
</html>

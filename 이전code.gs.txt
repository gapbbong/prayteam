
/**
 * âœ… ê¸°ë„ê·¸ë£¹ ê´€ë¦¬ìš© GAS (ê·¸ë£¹ID = ì‹œíŠ¸ì´ë¦„ êµ¬ì¡°)
 * - mode=login â†’ ê´€ë¦¬ìê³„ì • ì‹œíŠ¸ì—ì„œ í™•ì¸
 * - mode=signup â†’ ìƒˆ ê³„ì • ì¶”ê°€
 * - ê·¸ë£¹ID, ê·¸ë£¹ëª…ì€ "ê·¸ë£¹ì •ë³´" ì‹œíŠ¸ì—ì„œë§Œ ê´€ë¦¬
 * - ê° ê·¸ë£¹IDê°€ ê³§ ì‹œíŠ¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë¨ (ì˜ˆ: XL8IXTvhrRoknAKgQ1Gs)
 */

function doGet(e) {
  const mode = e.parameter.mode || "";

  switch (mode) {
    case "login": return handleLogin(e);
    case "signup": return handleSignup(e);
    case "getGroups": return handleGetGroups(e);
    case "getGroupById": return handleGetGroupById(e);
    case "getPrayers": return handleGetPrayers(e);
    case "getPrayersAll": return handleGetPrayersAll(e);
    case "getSubs": return handleGetSubs(e);
    default:
      return ContentService.createTextOutput("Invalid request")
        .setMimeType(ContentService.MimeType.TEXT);
  }
}

function doPost(e) {
  Logger.log("=== ğŸ“© doPost í˜¸ì¶œë¨ ===");

  if (!e) {
    Logger.log("âš  e ê°ì²´ ì—†ìŒ");
    return jsonOutput({ error: "no event object" });
  }

  Logger.log("â–¶ raw e.parameter: " + JSON.stringify(e.parameter));
  Logger.log("â–¶ raw e.postData: " + (e.postData ? e.postData.contents : "ì—†ìŒ"));

  let mode = e.parameter.mode || "";
  let data = {};

  if (e.postData && e.postData.contents) {
    try {
      data = JSON.parse(e.postData.contents);
      Logger.log("ğŸ“Œ JSON íŒŒì‹± ì„±ê³µ: " + JSON.stringify(data));
    } catch (err) {
      Logger.log("âŒ JSON íŒŒì‹± ì‹¤íŒ¨: " + err);
    }
  } else {
    Logger.log("âš  postData.contents ì—†ìŒ");
  }

  if (!mode && data.mode) {
    mode = data.mode;
    Logger.log("ğŸ“Œ data.modeë¡œ mode ì‹ë³„ë¨: " + mode);
  }

  Logger.log("â–¶ ìµœì¢… mode: " + mode);

  switch (mode) {
    case "renameGroup":
      Logger.log("=== âœ renameGroup ì‹¤í–‰ ===");
      return handleRenameGroup(e);

    case "deleteGroup":
      Logger.log("=== ğŸ—‘ deleteGroup ì‹¤í–‰ ===");
      return handleDeleteGroup(e);

    case "savePrayer": return handleSavePrayer(data);
    case "addMember": return handleAddMember(data);
    case "addGroup": return handleAddGroup(e);
    case "saveNote": return handleSaveNote(e);
    case "saveSub": return handleSaveSub(e);
    case "renameMember": return handleRenameMember(data);
    case "addSharedGroup":   return handleAddSharedGroup(e);
    case "addLog": return handleAddLog(e);
    case "logStay":  return handleLogStay(e);


    default:
      Logger.log("âš  ì•Œ ìˆ˜ ì—†ëŠ” mode: " + mode);
      return jsonOutput({ error: "invalid mode", received: mode });
  }
}

/* -------------------------------------------------------------------------- */
/* âœ… ê·¸ë£¹, ë©¤ë²„, ë¡œê·¸ì¸, íšŒì›ê°€ì…                                            */
/* -------------------------------------------------------------------------- */

function handleLogin(e) {
  const id = e.parameter.id || "";
  const pwd = e.parameter.pwd || "";
  const sheet = getOrCreateSheet("ê´€ë¦¬ìê³„ì •");

  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const idCol = headers.indexOf("ê´€ë¦¬ìID");
  const pwdCol = headers.indexOf("ë¹„ë°€ë²ˆí˜¸");

  const found = data.find(r => r[idCol] === id && String(r[pwdCol]) === String(pwd));
  if (!found) return jsonOutput({ success: false, message: "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜" });

  return jsonOutput({ success: true, message: "ë¡œê·¸ì¸ ì„±ê³µ" });
}

function handleSignup(e) {
  const id = e.parameter.id || "";
  const pwd = e.parameter.pwd || "";
  const email = e.parameter.email || "";
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê´€ë¦¬ìê³„ì •");
  if (!sheet) return jsonOutput({ success: false, message: "ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  const idCol = headers.indexOf("ê´€ë¦¬ìID");
  const emailCol = headers.indexOf("ì´ë©”ì¼");

  // ğŸ”¥ ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
  if (data.some(r => r[idCol] === id)) {
    return jsonOutput({ success: false, message: "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." });
  }

  // ğŸ”¥ ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬
  if (email && data.some(r => r[emailCol] === email)) {
    return jsonOutput({ success: false, message: "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤." });
  }

  // ê°€ì…ì¼ ì €ì¥
  const joinedAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");

  // ğŸ”¥ ìƒˆ ë°ì´í„° ì¶”ê°€
  sheet.appendRow([id, pwd, joinedAt, email]);
  return jsonOutput({ success: true, message: "íšŒì›ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤." });
}

function handleGetGroups(e) {
  const adminId = e.parameter.adminId || "";
  const sheet = getOrCreateSheet("ê·¸ë£¹ì •ë³´");
  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxAdmin = headers.indexOf("ê´€ë¦¬ìID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");
  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  // êµ¬ì„±ì› ì¹¼ëŸ¼ ìë™ íƒìƒ‰
  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  const groups = rows.slice(1)
    .filter(r =>
  String(r[idxAdmin]).normalize("NFKC").replace(/\s+/g, "") ===
  adminId.normalize("NFKC").replace(/\s+/g, "")
)

    .map(r => {
      // MODIFIED: ìˆ«ì/ë¬¸ì ëª¨ë‘ ì•ˆì „í•˜ê²Œ íŒŒì‹±
const members = memberCols
  .map(i => String(r[i] || "").trim())   // ìˆ«ì â†’ ë¬¸ìì—´ ë³€í™˜
  .filter(v => v !== "");                // ë¹ˆ ë¬¸ìì—´ ì œê±°


      return {
        ê´€ë¦¬ìID: r[idxAdmin],
        ê·¸ë£¹ëª…: r[idxGroupName],
        ê·¸ë£¹ID: r[idxGroupId],
        êµ¬ì„±ì›ìˆ˜: r[idxCount],
        êµ¬ì„±ì›ëª©ë¡: members
      };
    });

  return jsonOutput({ groups });
}

function handleGetGroupById(e) {
  const groupId = e.parameter.groupId || "";
  const sheet = getOrCreateSheet("ê·¸ë£¹ì •ë³´");
  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");

  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  const row = rows.find(r => r[idxGroupId] === groupId);
  if (!row) return jsonOutput({ error: "group not found" });

  // MODIFIED: ìˆ«ì í¬í•¨ ëª¨ë“  ê°’ ì•ˆì „ ì²˜ë¦¬
const members = memberCols
  .map(i => String(row[i] || "").trim())
  .filter(v => v !== "");


  return jsonOutput({
    group: {
      ê·¸ë£¹ID: row[idxGroupId],
      ê·¸ë£¹ëª…: row[idxGroupName],
      êµ¬ì„±ì›ëª©ë¡: members,
    },
  });
}

/* -------------------------------------------------------------------------- */
/* âœ… ê¸°ë„ì œëª© ì €ì¥ ë° ì¡°íšŒ                                                   */
/* -------------------------------------------------------------------------- */

function handleSavePrayer(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = data.groupId;
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = ss.insertSheet(sheetName);

  const headers = sheet.getLastRow() === 0
    ? createPrayerHeaders(sheet, 6)
    : sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  const maxCols = (headers.length - 4) / 3;
  const needed = Math.max(data.prayers.length, maxCols);

  if (needed > maxCols) {
    for (let i = maxCols + 1; i <= needed; i++) {
      sheet.getRange(1, sheet.getLastColumn() + 1, 1, 3).setValues([[`ê¸°ë„ì œëª©${i}`, `R${i}`, `C${i}`]]);
    }
  }

  const now = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy.MM.dd a h:mm:ss");
  const prayerCells = [];
  for (let i = 0; i < needed; i++) prayerCells.push(data.prayers[i] || "", "", "");
  const row = [data.groupName, data.groupId, data.member, now, ...prayerCells];
  sheet.appendRow(row);
  // ğŸ”” Netlify notify í•¨ìˆ˜ í˜¸ì¶œ (í•´ë‹¹ ê·¸ë£¹ êµ¬ë…ì ëª¨ë‘ì—ê²Œ)
UrlFetchApp.fetch("https://prayteam.creat1324.com/.netlify/functions/notify", {
  method: "post",
  contentType: "application/json",
  payload: JSON.stringify({
    groupId: data.groupId,
    title: `${data.member}ë‹˜ì´ ìƒˆë¡œìš´ ê¸°ë„ì œëª©ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.`,
    message: data.prayers[0] || "(ë‚´ìš© ì—†ìŒ)"
  })
});

  return jsonOutput({ success: true, message: "ì €ì¥ ì™„ë£Œ", time: now });
}

function createPrayerHeaders(sheet, count) {
  const headers = ["ê·¸ë£¹ëª…", "ê·¸ë£¹ID", "ë©¤ë²„ì´ë¦„", "ì‘ì„±ì‹œê°„"];
  for (let i = 1; i <= count; i++) headers.push(`ê¸°ë„ì œëª©${i}`, `R${i}`, `C${i}`);
  sheet.appendRow(headers);
  return headers;
}

function handleGetPrayers(e) {
  const groupId = e.parameter.groupId || "";
  const member = e.parameter.member || "";
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(groupId);
  if (!sheet) return jsonOutput({});

  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const memberCol = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const timeCol = headers.indexOf("ì‘ì„±ì‹œê°„");

  // ê¸°ë„ì œëª© / R / C ì»¬ëŸ¼ ì¸ë±ìŠ¤ ìˆ˜ì§‘
  const prayerCols = [];
  const rCols = [];
  const cCols = [];

  headers.forEach((h, i) => {
    if (typeof h !== "string") return;
    if (h.startsWith("ê¸°ë„ì œëª©")) {
      prayerCols.push(i);
    } else if (/^R\d+$/.test(h)) {
      rCols.push(i);
    } else if (/^C\d+$/.test(h)) {
      cCols.push(i);
    }
  });

  // í•´ë‹¹ ë©¤ë²„ì˜ "ìµœì‹  í–‰" ì°¾ê¸° (ì•„ë˜ì—ì„œ ìœ„ë¡œ)
  for (let i = data.length - 1; i >= 1; i--) {
    const row = data[i];
    if (String(row[memberCol]).trim() === member) {
      const prayers = prayerCols.map(idx => row[idx] || "").filter(v => v !== "");
      const responses = rCols.map(idx => row[idx] || "");
      const comments = cCols.map(idx => row[idx] || "");

      return jsonOutput({
        groupId,
        member,
        prayers,
        responses,
        comments,
        time: row[timeCol]
      });
    }
  }

  // ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´
  return jsonOutput({});
}

function handleGetPrayersAll(e) {
  const groupId = e.parameter.groupId || "";
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(groupId);
  if (!sheet) return jsonOutput([]);

  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return jsonOutput([]);

  const headers = data.shift().map(String);
  const idxGroup = headers.indexOf("ê·¸ë£¹ëª…");
  const idxMember = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const idxTime = headers.indexOf("ì‘ì„±ì‹œê°„");
  const prayerCols = headers.map((h, i) => h.startsWith("ê¸°ë„ì œëª©") ? i : -1).filter(i => i !== -1);

  const latest = {};
  for (let i = data.length - 1; i >= 0; i--) {
    const row = data[i];
    const member = row[idxMember];
    if (!member || latest[member]) continue;
    latest[member] = {
      ê·¸ë£¹ëª…: row[idxGroup],
      ë©¤ë²„ì´ë¦„: member,
      prayers: prayerCols.map(idx => row[idx]).filter(Boolean),
      ì‘ì„±ì‹œê°„: row[idxTime],
    };
  }
  return jsonOutput(Object.values(latest));
}

/* -------------------------------------------------------------------------- */
/* âœ… ë©¤ë²„ ì¶”ê°€                                                               */
/* -------------------------------------------------------------------------- */
function handleAddMember(data) {
  const { groupId, newMember } = data;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  // êµ¬ì„±ì›n ìë™ íƒìƒ‰
  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter((i) => i !== -1);

  let rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);
  if (rowIndex === -1) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const row = rows[rowIndex];

  // ê¸°ì¡´ êµ¬ì„±ì› ë¡œë“œ
  // MODIFIED: ë¬¸ìì—´ë§Œ í•„í„°ë§í•˜ë„ë¡ ìˆ˜ì •
  // MODIFIED: ëª¨ë“  ê°’ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì•ˆì „ íŒŒì‹±
const current = memberCols
  .map(i => String(row[i] || "").trim())
  .filter(v => v !== "");



  // ì¤‘ë³µ ì²´í¬ + ìë™ ìˆ«ì ì¦ê°€
  let finalName = newMember;
  let cnt = 2;
  while (current.includes(finalName)) {
    finalName = newMember + cnt;
    cnt++;
  }

  // ë¹„ì–´ìˆëŠ” ì»¬ëŸ¼ ì°¾ê¸°
  let targetCol = -1;
  for (const col of memberCols) {
    if (!row[col]) {
      targetCol = col;
      break;
    }
  }

  // êµ¬ì„±ì› ì¹¼ëŸ¼ ë¶€ì¡±í•˜ë©´ í•œ ì¹¼ëŸ¼ ìƒì„±
  if (targetCol === -1) {
    targetCol = sheet.getLastColumn();
    const newHeader = `êµ¬ì„±ì›${memberCols.length + 1}`;
    sheet.getRange(1, targetCol + 1).setValue(newHeader);
  }

  // ê°’ ì“°ê¸°
  sheet.getRange(rowIndex + 1, targetCol + 1).setValue(finalName);

  // êµ¬ì„±ì›ìˆ˜ ì—…ë°ì´íŠ¸
  sheet.getRange(rowIndex + 1, idxCount + 1).setValue(current.length + 1);

  return jsonOutput({
    success: true,
    message: `${finalName} ì¶”ê°€ ì™„ë£Œ`,
    count: current.length + 1,
  });
}

/* -------------------------------------------------------------------------- */
function getOrCreateSheet(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let s = ss.getSheetByName(name);
  if (!s) s = ss.insertSheet(name);
  return s;
}

function jsonOutput(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleRenameMember(data) {
  const { groupId, oldName, newName } = data;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const groupSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!groupSheet) return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

  const rows = groupSheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");

  // êµ¬ì„±ì› ì»¬ëŸ¼ ìë™ íƒìƒ‰
  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  // ëŒ€ìƒ í–‰ ì°¾ê¸°
  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);
  if (rowIndex === -1) {
    return jsonOutput({ success: false, message: "í•´ë‹¹ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const row = rows[rowIndex];

  // êµ¬ì„±ì› ëª©ë¡ì—ì„œ oldName â†’ newName
  let replaced = false;
  memberCols.forEach(col => {
    if (String(row[col]).trim() === oldName) {
      groupSheet.getRange(rowIndex + 1, col + 1).setValue(newName);
      replaced = true;
    }
  });

  if (!replaced) {
    return jsonOutput({ success: false, message: "ê¸°ì¡´ ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." });
  }

  // --- [ê¸°ë„ì œëª© ì‹œíŠ¸] ë©¤ë²„ ì´ë¦„ ë³€ê²½ ---
  const prayerSheet = ss.getSheetByName(groupId);
  if (prayerSheet) {
    const dataRows = prayerSheet.getDataRange().getValues();
    const headers2 = dataRows[0];
    const idxMember = headers2.indexOf("ë©¤ë²„ì´ë¦„");

    for (let i = 1; i < dataRows.length; i++) {
      if (String(dataRows[i][idxMember]).trim() === oldName) {
        prayerSheet.getRange(i + 1, idxMember + 1).setValue(newName);
      }
    }
  }

  return jsonOutput({
    success: true,
    message: `'${oldName}' â†’ '${newName}' ì´ë¦„ ìˆ˜ì • ì™„ë£Œ`
  });
}

function handleRenameGroup(e) {
  Logger.log("=== âœ handleRenameGroup í˜¸ì¶œë¨ ===");

  let body = {};
  try {
    Logger.log("â–¶ raw body: " + e.postData.contents);
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    Logger.log("âŒ JSON íŒŒì‹± ì˜¤ë¥˜: " + err);
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  Logger.log("â–¶ íŒŒì‹±ëœ body: " + JSON.stringify(body));

  const groupId = body.groupId;
  const newName = body.newName;

  Logger.log("â–¶ groupId: " + groupId);
  Logger.log("â–¶ newName: " + newName);

  if (!groupId || !newName) {
    Logger.log("âŒ groupId ë˜ëŠ” newName ëˆ„ë½");
    return jsonOutput({ success: false, message: "groupId ë˜ëŠ” newName ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");

  if (!sheet) {
    Logger.log("âŒ ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ ì—†ìŒ");
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  const idxID = headers.indexOf("ê·¸ë£¹ID");
  const idxName = headers.indexOf("ê·¸ë£¹ëª…");

  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);

  Logger.log("â–¶ rowIndex ì°¾ì€ ê²°ê³¼: " + rowIndex);

  if (rowIndex === -1) {
    Logger.log("âŒ í•´ë‹¹ ê·¸ë£¹ í–‰ì„ ì°¾ì§€ ëª»í•¨");
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  Logger.log("â–¶ ì‹œíŠ¸ì— ì“°ëŠ” ê°’: " + newName);

  sheet.getRange(rowIndex + 1, idxName + 1).setValue(newName);

  Logger.log("âœ” ê·¸ë£¹ëª… ìˆ˜ì • ì™„ë£Œ");

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ëª…ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
  });
}

function handleDeleteGroup(e) {
  Logger.log("=== ğŸ—‘ handleDeleteGroup í˜¸ì¶œë¨ ===");

  let data = {};
  try {
    Logger.log("â–¶ raw body: " + e.postData.contents);
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    Logger.log("âŒ JSON íŒŒì‹± ì‹¤íŒ¨: " + err);
  }

  Logger.log("â–¶ íŒŒì‹±ëœ data: " + JSON.stringify(data));

  const groupId = data.groupId;
  Logger.log("â–¶ groupId: " + groupId);

  if (!groupId) {
    Logger.log("âŒ groupId ì—†ìŒ");
    return jsonOutput({ success: false, message: "groupIdê°€ ì—†ìŠµë‹ˆë‹¤." });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const infoSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!infoSheet) {
    Logger.log("âŒ ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ ì—†ìŒ");
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const rows = infoSheet.getDataRange().getValues();
  const headers = rows[0];
  const idxID = headers.indexOf("ê·¸ë£¹ID");

  const rowIndex = rows.findIndex((r, i) => i > 0 && r[idxID] === groupId);
  Logger.log("â–¶ ì‚­ì œí•  í–‰ rowIndex: " + rowIndex);

  if (rowIndex !== -1) infoSheet.deleteRow(rowIndex + 1);

  const prayerSheet = ss.getSheetByName(groupId);
  if (prayerSheet) {
    Logger.log("â–¶ ê¸°ë„ì œëª© ì‹œíŠ¸ ì‚­ì œ");
    ss.deleteSheet(prayerSheet);
  }

  Logger.log("âœ” ì‚­ì œ ì™„ë£Œ");

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ì´ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
  });
}

function handleSaveNote(e) {
  const body = JSON.parse(e.postData.contents);
  const { groupId, member, index, answer, comment } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(groupId);
  if (!sheet) return jsonOutput({ success: false, message: "sheet ì—†ìŒ" });

  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const idxMember = headers.indexOf("ë©¤ë²„ì´ë¦„");
  const idxR = headers.indexOf(`R${index}`);
  const idxC = headers.indexOf(`C${index}`);

  // ìµœì‹ í–‰ ì°¾ê¸°
  let target = -1;
  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][idxMember]).trim() === member) {
      target = i + 1;
      break;
    }
  }

  if (target === -1) {
    return jsonOutput({ success: false, message: "ì €ì¥ëœ ê¸°ë„ì œëª© ì—†ìŒ" });
  }

  // ì €ì¥ (ì´ˆê¸°í™” í¬í•¨)
  sheet.getRange(target, idxR + 1).setValue(answer || "");
  sheet.getRange(target, idxC + 1).setValue(comment || "");

  return jsonOutput({ success: true });
}

function handleAddGroup(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { adminId, groupName, members } = body;

  if (!adminId || !groupName || !members || members.length === 0) {
    return jsonOutput({ success: false, message: "í•„ìˆ˜ í•­ëª© ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´") || ss.insertSheet("ê·¸ë£¹ì •ë³´");

  const rows = sheet.getDataRange().getValues();
  const headers = rows[0];

  // ğŸ”¥ ìƒˆ ì»¬ëŸ¼ ì¸ë±ìŠ¤ (ìƒì„±ì¼ ì¶”ê°€ëœ êµ¬ì¡° ê¸°ì¤€)
  const idxAdmin     = headers.indexOf("ê´€ë¦¬ìID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");
  const idxGroupId   = headers.indexOf("ê·¸ë£¹ID");
  const idxCreated   = headers.indexOf("ìƒì„±ì¼");     // â˜… ìƒì„±ì¼
  const idxCount     = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  // êµ¬ì„±ì› ì»¬ëŸ¼ ìë™ íƒìƒ‰
  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜" ? i : -1))
    .filter(i => i !== -1);

  // ê·¸ë£¹ID ìë™ ìƒì„±
  const newGroupId = "G" + Math.random().toString(36).substring(2, 14);

  // ìƒì„±ì¼(yyyy-MM-dd HH:mm:ss KST)
  const createdAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");

  // êµ¬ì„±ì› ì¹¼ëŸ¼ ë¶€ì¡±í•˜ë©´ ìë™ í™•ì¥
  while (members.length > memberCols.length) {
    const nextIndex = memberCols.length + 1;
    sheet.getRange(1, sheet.getLastColumn() + 1).setValue("êµ¬ì„±ì›" + nextIndex);
    memberCols.push(sheet.getLastColumn() - 1);
  }

  // ìƒˆ í–‰ í…œí”Œë¦¿ ìƒì„± (ì „ì²´ ê¸¸ì´ì— ë§ì¶° ë¹ˆì¹¸ìœ¼ë¡œ)
  const newRow = new Array(headers.length).fill("");

  // ğŸ”¥ ìƒˆ êµ¬ì¡°ì— ë§ê²Œ ê°’ ë„£ê¸°
  newRow[idxAdmin]     = adminId;
  newRow[idxGroupName] = groupName;
  newRow[idxGroupId]   = newGroupId;
  newRow[idxCreated]   = createdAt;        // â˜… ìƒì„±ì¼ ë„£ê¸°
  newRow[idxCount]     = members.length;

  // êµ¬ì„±ì›ë“¤ ë„£ê¸°
  members.forEach((m, i) => {
    const col = memberCols[i];
    newRow[col] = m;
  });

  sheet.appendRow(newRow);

  return jsonOutput({
    success: true,
    message: "ê·¸ë£¹ ì¶”ê°€ ì™„ë£Œ",
    groupId: newGroupId,
    createdAt
  });
}

function handleAddSharedGroup(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { adminId, groupId } = body;

  if (!adminId || !groupId) {
    return jsonOutput({ success: false, message: "í•„ìˆ˜ ê°’ ëˆ„ë½" });
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const infoSheet = ss.getSheetByName("ê·¸ë£¹ì •ë³´");
  if (!infoSheet) {
    return jsonOutput({ success: false, message: "ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ ì—†ìŒ" });
  }

  const rows = infoSheet.getDataRange().getValues();
  const headers = rows[0];
  const idxGroupId = headers.indexOf("ê·¸ë£¹ID");
  const idxGroupName = headers.indexOf("ê·¸ë£¹ëª…");

  // êµ¬ì„±ì› ì»¬ëŸ¼ ìë™ íƒìƒ‰
  const memberCols = headers
    .map((h, i) => (h.startsWith("êµ¬ì„±ì›") && h !== "êµ¬ì„±ì›ìˆ˜") ? i : -1)
    .filter(i => i !== -1);

  // ë³µì œí•  ì›ë³¸ ê·¸ë£¹ ì°¾ê¸°
  const source = rows.find(r => r[idxGroupId] === groupId);
  if (!source) {
    return jsonOutput({ success: false, message: "ì›ë³¸ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }

  const groupName = source[idxGroupName];

  const members = memberCols
    .map(i => String(source[i] || "").trim())
    .filter(v => v !== "");

  // â• ìƒˆ ê·¸ë£¹ID ìƒì„±
  const newGroupId = "G" + Math.random().toString(36).substring(2, 14);

  // ìƒì„±ì¼
  const createdAt = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");

  const idxAdmin  = headers.indexOf("ê´€ë¦¬ìID");
  const idxCreated = headers.indexOf("ìƒì„±ì¼");
  const idxCount = headers.indexOf("êµ¬ì„±ì›ìˆ˜");

  // ê¸°ì¡´ í—¤ë” ê¸¸ì´ë§Œí¼ ë¹ˆ ë°°ì—´ ìƒì„±
  const newRow = new Array(headers.length).fill("");

  // ê°’ ë„£ê¸°
  newRow[idxAdmin] = adminId;
  newRow[idxGroupName] = groupName + " (ê³µìœ )";
  newRow[idxGroupId] = newGroupId;
  newRow[idxCreated] = createdAt;
  newRow[idxCount] = members.length;

  members.forEach((m, i) => {
    const col = memberCols[i];
    newRow[col] = m;
  });

  infoSheet.appendRow(newRow);

  return jsonOutput({
    success: true,
    message: "ê³µìœ  ê·¸ë£¹ì´ ë‚´ ê·¸ë£¹ìœ¼ë¡œ ë³µì œ ì™„ë£Œ",
    groupId: newGroupId
  });
}

/* -------------------------------------------------------------------------- */
/*  ğŸ“Œ í˜ì´ì§€ ë°©ë¬¸ ë¡œê·¸ ê¸°ë¡                                                  */
/* -------------------------------------------------------------------------- */

function handleAddLog(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { page, adminId, groupId, member, from, device, browser } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ë°©ë¬¸ë¡œê·¸") || ss.insertSheet("ë°©ë¬¸ë¡œê·¸");

  // ğŸ”¥ í—¤ë” í†µí•© (10ê°œë¡œ ê³ ì •)
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      "ë‚ ì§œ","ì‹œê°„","í˜ì´ì§€","adminId","groupId","member",
      "from","device","browser","ì²´ë¥˜ì´ˆ"
    ]);
  }

  const now = new Date();
  const dateStr = Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd");
  const timeStr = Utilities.formatDate(now, "Asia/Seoul", "HH:mm:ss");

  // ğŸ”¥ ì²´ë¥˜ì´ˆëŠ” ë¹ˆì¹¸
  sheet.appendRow([
    dateStr, timeStr, page || "", adminId || "", groupId || "",
    member || "", from || "", device || "", browser || "", ""
  ]);

  return jsonOutput({ success: true });
}

function handleLogStay(e) {
  let body = {};
  try {
    body = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonOutput({ success: false, message: "JSON íŒŒì‹± ì‹¤íŒ¨" });
  }

  const { page, groupId, stay, time } = body;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ë°©ë¬¸ë¡œê·¸") || ss.insertSheet("ë°©ë¬¸ë¡œê·¸");

  // ğŸ”¥ í—¤ë” í†µí•©
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      "ë‚ ì§œ","ì‹œê°„","í˜ì´ì§€","adminId","groupId","member",
      "from","device","browser","ì²´ë¥˜ì´ˆ"
    ]);
  }

  const dateObj = new Date(time);
  const dateStr = Utilities.formatDate(dateObj, "Asia/Seoul", "yyyy-MM-dd");
  const timeStr = Utilities.formatDate(dateObj, "Asia/Seoul", "HH:mm:ss");

  sheet.appendRow([
    dateStr, timeStr, page || "", "", groupId || "",
    "", "", "", "", stay || 0
  ]);

  return jsonOutput({ success: true });
}


<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>ê¸°ë„ì œëª© ê¸°ë¡</title>
  <script src="/app-config.js"></script>

  <style>
:root {
  --bg-gradient: radial-gradient(circle at top, #1c1f3a, #0d0e16);
  --text-bright: #ffffff;
  --text-dim: #cccccc;
  --accent-gold: #ffdf6b;
  --blue: #4f9cff;
  --blue-dark: #367de3;
  --card-bg: rgba(255, 255, 255, 0.07);
  --border-light: rgba(255, 255, 255, 0.2);
  --shadow: 0 4px 14px rgba(255, 255, 255, 0.1);
  --shadow-hover: 0 6px 18px rgba(255, 255, 255, 0.15);
  --radius: 14px;
  --line-height: 1.6;
}

/* ì „ì²´ êµ¬ì¡° */
body {
  font-family: "Noto Sans KR", sans-serif; /* ê°™ì€ í°íŠ¸ */
  background: var(--bg-gradient);
  color: var(--text-bright);
  margin: 0;
  padding: 20px;
  text-align: center;
  min-height: 100vh;
  font-size: clamp(15px, 2.4vw, 18px);
}

/* ìƒë‹¨ ì œëª© ì˜ì—­ */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  position: sticky;
  top: 0;
  background: var(--bg-gradient);
  z-index: 10;
  padding: 6px 10px;
}
.top-bar h2 {
  flex: 1;
  text-align: center;
  font-weight: 700;
  color: var(--accent-gold);
  margin: 0;
  font-size: clamp(24px, 5vw, 34px);
}
.home-btn, .share-btn {
  background: none;
  border: none;
  color: var(--accent-gold);
  cursor: pointer;
  transition: transform 0.2s ease, opacity 0.2s ease;
  font-size: clamp(22px, 4vw, 30px);
}
.home-btn:hover, .share-btn:hover {
  transform: scale(1.2);
  opacity: 0.85;
}

/* ê°œë³„ ë©¤ë²„ ì„¹ì…˜ */
.member-section {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px 14px;
  margin-bottom: 20px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.member-section:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.member-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  gap: 10px;
}
.member-name {
  flex: 1;
  text-align: left;
  font-size: clamp(21px, 2.8vw, 24px);
  font-weight: 600;
  color: #ffdf6b;
  display: flex;
  align-items: center;
  height: 38px;
}
.save-btn {
  background: var(--blue);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0 16px;
  font-size: clamp(16px, 2.5vw, 19px);
  height: 38px;
  cursor: pointer;
  transition: background 0.2s, transform 0.2s;
}
.save-btn:hover { background: var(--blue-dark); transform: translateY(-1px); }
.save-btn:disabled { background: #555; color: #ccc; cursor: not-allowed; }

/* ë¡œë”© */
#loadingPrayers {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: #ffdf6b;
  margin-top: 30px;
}
#loadingPrayers .mini-loader {
  border: 3px solid rgba(255,255,255,0.2);
  border-top: 3px solid #ffdf6b;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* âœ… ê¸°ë„ì œëª© ë¦¬ìŠ¤íŠ¸ êµ¬ì¡° */
.prayer-container {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-bottom: 3px;
}

/* âœ… ê¸°ë„ì œëª© í•œ ì¤„ ë†’ì´ ì¶•ì†Œ + ì™¼ìª½ ì •ë ¬ */
.prayer-item {
  display: flex;
  align-items: flex-start; /* ê°€ìš´ë° ì •ë ¬ë¡œ ê· í˜• ìˆê²Œ */
  position: relative;
  margin-bottom: 2px;
  min-height: 36px; /* ë†’ì´ ì¤„ì„ */
}

/* ë²ˆí˜¸ ì™¼ìª½ ê°„ê²© ì¶•ì†Œ */
.prayer-number {
  font-size: 17px;
  font-weight: 600;
  color: white;
  width: 10px; /* í­ ì¤„ì„ */
  text-align: right;
  margin-right: 6px; /* ê°„ê²© ì¤„ì„ */
  user-select: none;
  line-height: 1.35;   /* â­ ë²ˆí˜¸ ì„¸ë¡œ ê¸°ì¤€ì„ í…ìŠ¤íŠ¸ì™€ ë§ì¶¤ */
  margin-top: 3px;     /* â­ ì•„ì£¼ ì‚´ì§ ë‚´ë ¤ê° */
}

/* ì…ë ¥ì¹¸ ì™¼ìª½ìœ¼ë¡œ ë” ë‹¹ê¹€ + ë†’ì´ ì¶•ì†Œ */
.prayer-textarea {
  flex: none;          /* âœ… flex ê³„ì‚° ë¹„í™œì„±í™” */
  width: 88%;       
  resize: none;
  min-height: 22px;
  max-height: 140px;
  font-size: 18px;
  font-weight: 600;
  line-height: 1.3; /* í•œ ì¤„ ê°„ê²© ì¤„ì„ */
  border: none;             /* âœ… í…Œë‘ë¦¬ ì œê±° */
  outline: none;            /* âœ… í¬ì»¤ìŠ¤ ì‹œ íŒŒë€ ì™¸ê³½ì„ ë„ ì œê±° */
  border-radius: 6px;
  outline: none;
  background-color: #2a2a3a;
  color: #eee;
  font-family: "Noto Sans KR", sans-serif; /* ì´ë¦„ê³¼ ë™ì¼í•œ í°íŠ¸ */
  transition: border-color 0.2s;
}

/* hover ì‹œ ìƒ‰ê° ì‚´ì§ ê°•ì¡° */
.prayer-textarea:focus {
  border-color: var(--accent-gold);
}
.delete-btn {
  align-items: flex-end;      /* ìˆ˜ì§ ì¤‘ì•™ì •ë ¬ */
  border: none;
  background: transparent;
  color: #eee;
  font-size: 20px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.delete-btn:hover {
  background-color: rgba(255, 128, 128, 0.15);
  transform: scale(1.15);
}

/* ì¶”ê°€ ë²„íŠ¼ */
.add-btn {
  background: transparent;     /* âœ” íˆ¬ëª… ë°°ê²½ */
  border: none;       /* âœ” í…Œë‘ë¦¬ í°ìƒ‰ */
  color: #e5e5e5;                 /* âœ” + ì•„ì´ì½˜ í°ìƒ‰ */
  border-radius: 10px;
  padding: 10px 0;
  width: 48px;                    /* âœ” ì •ì‚¬ê°í˜• ë²„íŠ¼ ëŠë‚Œ */
  height: 34px;
  font-size: 15px;                /* âœ” + ë” í¬ê³  ì„ ëª…í•˜ê²Œ */
  cursor: pointer;
  transition: 0.2s;
}
.add-btn:hover {
  color: #ffffff;              /* âœ” hover ì‹œ ë” ë°ê²Œ */
  transform: scale(1.1); 
}

/* ì‹œê°„ í‘œì‹œ */
.timestamp {
  text-align: right;
  font-size: clamp(13px, 2.2vw, 15px);
  color: var(--text-dim);
  margin-top: 6px;
}

.bottom-row {
  position: relative;        /* ìì‹ ìš”ì†Œ ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜ ê°€ëŠ¥í•˜ê²Œ */
  display: flex;
  justify-content: center;   /* ë²„íŠ¼ì„ ê°€ìš´ë° ì •ë ¬ */
  align-items: center;
  margin-top: 6px;
}

/* ì‹œê°„ë§Œ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ì´ë™ */
.bottom-row .timestamp {
  position: absolute;
  right: 10px;               /* ì˜¤ë¥¸ìª½ ì—¬ë°± */
  top: 50%;
  transform: translateY(-50%);
}

.add-btn {
  margin: 0;
  padding: 6px 14px;
}

.timestamp {
  margin: 0;
  font-size: 14px;
  color: var(--text-dim);
}

/* ë©¤ë²„ ì¶”ê°€ ë¡œë”© ìŠ¤í”¼ë„ˆ */
.member-add-loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 6px;
  vertical-align: middle;
}

.saved-success {
  background-color: #4ade80 !important; /* ì´ˆë¡ìƒ‰ */
  transition: background-color 0.4s;
}

/* âœ¨ ì „ì²´ ë°°ê²½ ì…ì ìº”ë²„ìŠ¤ */
#particleCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none; /* í™”ë©´ ë²„íŠ¼ í´ë¦­ ë°©í•´ X */
  z-index: 2; /* ì¹´ë“œë³´ë‹¤ ë’¤, ë°°ê²½ë³´ë‹¤ ìœ„ */
  opacity: 0.55;
}

</style>

</head>

<body>
  <div class="top-bar">
    <button class="home-btn" onclick="goHome()">ğŸ </button>
    <h2 id="title">ê·¸ë£¹ëª… ê¸°ë„ì œëª©</h2>
    <button class="share-btn" onclick="shareGroup()" aria-label="ê³µìœ í•˜ê¸°">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 3v12"/>
    <path d="M16 7l-4-4-4 4"/>
    <path d="M19 15v5H5v-5"/>
  </svg>
</button>

	<button id="notifyBtn" class="notify-btn">ğŸ”” ì•Œë¦¼ ì„¤ì •</button>

  </div>

<!-- âœ… ìƒˆ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ (index.htmlê³¼ ë™ì¼) -->
<div id="loadingPrayers">
  <div class="mini-loader"></div>
  <p>ê¸°ë„ì œëª© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<div id="memberContainer" style="display:none;"></div>

<!-- âœ… ë©¤ë²„ ì¶”ê°€ UI -->
<div id="addMemberArea" style="margin-top:30px; text-align:center;">
  <button id="openAddMemberBtn"
     style="padding:10px 18px; font-size:18px; border-radius:10px; background:#4f9cff; color:white; border:none; cursor:pointer;">
     â• ìƒˆ ë©¤ë²„ ì¶”ê°€
  </button>

  <div id="addMemberForm" style="display:none; margin-top:15px;">
    <input id="newMemberName"
      placeholder="ìƒˆ ë©¤ë²„ ì´ë¦„ ì…ë ¥"
      style="padding:10px; font-size:18px; width:70%; border-radius:10px; border:none; outline:none;" />

    <button id="saveNewMemberBtn"
      style="padding:10px 18px; font-size:18px; border-radius:10px; background:#ffdf6b; margin-left:10px; cursor:pointer;">
      ì €ì¥
    </button>
  </div>
</div>

<!-- âœ¨ ë¹›ì…ì + ì‹­ìê°€ ì…ì íš¨ê³¼ -->
<canvas id="particleCanvas"></canvas>

  <script>
    const scriptURL = CONFIG.GAS_URL;

    // âœ… Service Worker ë“±ë¡ ë° ìë™ ì—…ë°ì´íŠ¸ ê°ì§€
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").then((reg) => {
        console.log("âœ… Service Worker ë“±ë¡ ì™„ë£Œ:", reg.scope);
        reg.addEventListener("updatefound", () => {
          const newSW = reg.installing;
          newSW.addEventListener("statechange", () => {
            if (newSW.state === "installed" && navigator.serviceWorker.controller) {
              alert("ğŸ”„ ìƒˆë¡œìš´ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
              window.location.reload();
            }
          });
        });
      }).catch(err => console.error("âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:", err));
    }

    // âœ… URLì—ì„œ ê·¸ë£¹ ID íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    const params = new URLSearchParams(window.location.search);
    const groupId = params.get("gid");

/* -------------------------------------------
   ğŸŸ¦ ë©¤ë²„ ì´ë¦„ ë¡±í”„ë ˆìŠ¤ â†’ ì´ë¦„ ìˆ˜ì • ëª¨ë‹¬ í˜¸ì¶œ
------------------------------------------- */
// MODIFIED: ë¡±í”„ë ˆìŠ¤ ë³€ìˆ˜
let renamePressTimer = null;
let enterTime = Date.now();

function startRenamePress(e, member) {
  renamePressTimer = setTimeout(() => {
    openInlineRenameBox(member, e.target.closest(".member-section"));
  }, 700);
}

/* --------------------------------------------------
   ğŸŸ¦ ì¸ë¼ì¸ ë©¤ë²„ ì´ë¦„ ìˆ˜ì • ë°•ìŠ¤ ìƒì„±
-------------------------------------------------- */
function openInlineRenameBox(member, sectionEl) {

  // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ì œê±°
  if (renameBox) renameBox.remove();

  renameTarget = member;

  // ë°•ìŠ¤ DOM ìƒì„±
  renameBox = document.createElement("div");
  renameBox.style.background = "#2a2a3a";
  renameBox.style.padding = "14px";
  renameBox.style.marginTop = "12px";
  renameBox.style.borderRadius = "10px";
  renameBox.style.boxShadow = "0 4px 14px rgba(0,0,0,0.3)";
  renameBox.style.textAlign = "left";

  renameBox.innerHTML = `
    <div style="color:#ffdf6b; font-size:18px; margin-bottom:8px;">
      ğŸ“ ë©¤ë²„ ì´ë¦„ ìˆ˜ì •
    </div>

    <input id="renameInput"
      style="width:90%; padding:10px; font-size:18px; border-radius:8px; border:none; outline:none;
      background:#fff; color:#000;" 
      value="${member}"/>

    <div style="margin-top:12px; display:flex; gap:10px;">
      <button id="saveInlineRenameBtn" onclick="saveInlineRename()" 
  style="padding:8px 14px; background:#4f9cff; border:none; border-radius:8px;">
  ìˆ˜ì •
</button>


      <button onclick="cancelInlineRename()" 
        style="padding:8px 14px; background:#777; border:none; border-radius:8px;">ì·¨ì†Œ</button>
    </div>
  `;

  // ì¹´ë“œ ë°”ë¡œ ì•„ë˜ì— ì‚½ì…
  sectionEl.insertAdjacentElement("afterend", renameBox);
}

function cancelInlineRename() {
  if (renameBox) renameBox.remove();
  renameBox = null;
  renameTarget = null;
}

/* --------------------------------------------------
   ğŸŸ¦ ì´ë¦„ ì €ì¥ (GAS renameMember í•„ìš”)
-------------------------------------------------- */
async function saveInlineRename() {
  const newName = document.getElementById("renameInput").value.trim();
  if (!newName) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

  // ğŸ”µ 1) ìˆ˜ì • ë²„íŠ¼ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  const btn = document.getElementById("saveInlineRenameBtn");
  if (btn) {
    btn.innerHTML = `â³ ì €ì¥ì¤‘...`;
    btn.disabled = true;
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "renameMember",
        groupId,
        oldName: renameTarget,
        newName
      })
    });

    const json = await res.json();
    console.log("ğŸ”„ ì´ë¦„ ì €ì¥ ê²°ê³¼:", json);

    if (!json.success) {
      alert("ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: " + json.message);
      if (btn) {
        btn.innerHTML = "ìˆ˜ì •";
        btn.disabled = false;
      }
      return;
    }

    // ğŸŸ¢ 2) ì €ì¥ë¨ ì• ë‹ˆë©”ì´ì…˜
    if (btn) {
      btn.innerHTML = "âœ” ì €ì¥ë¨";
      btn.style.backgroundColor = "#4ade80"; // ì´ˆë¡ìƒ‰
    }

    // ì ê¹ â€œì €ì¥ë¨â€ ìœ ì§€
    await new Promise(r => setTimeout(r, 800));

    // UI ë‹«ê¸°
    cancelInlineRename();

    // í™”ë©´ ë¦¬ë¡œë“œ
    await loadGroupMembers();

  } catch (err) {
    console.error(err);
    alert("ì˜¤ë¥˜ ë°œìƒ: ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

    if (btn) {
      btn.innerHTML = "ìˆ˜ì •";
      btn.disabled = false;
    }
  }
}

function cancelRenamePress() {
  clearTimeout(renamePressTimer);
}


    // âœ… ê·¸ë£¹ ë° êµ¬ì„±ì› ë¶ˆëŸ¬ì˜¤ê¸°
async function loadGroupMembers() {
      const adminId = localStorage.getItem("adminId");           // MODIFIED
      const isAdminMode =
        adminId !== null && adminId !== undefined && adminId !== ""; // MODIFIED
      const isAdmin = isAdminMode;                               // MODIFIED: ë³„ì¹­ ì¶”ê°€ë¡œ ì—ëŸ¬ ë°©ì§€

      let group = null;

      try {
        const url = isAdmin
          ? `${scriptURL}?mode=getGroups&adminId=${adminId}`      // ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          : `${scriptURL}?mode=getGroupById&groupId=${groupId}`;
        const res = await fetch(url);
        const json = await res.json();

        group = isAdmin
          ? json.groups?.find(g => g.ê·¸ë£¹ID === groupId)
          : json.group;

      } catch (err) {
        console.error("âŒ ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
      }

      const title = document.getElementById("title");
      const loading = document.getElementById("loadingPrayers");
      const container = document.getElementById("memberContainer");

      if (!group) {
        title.textContent = "ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        loading.textContent = "âš ï¸ ê·¸ë£¹ ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        return;
      }

      title.textContent = `${group.ê·¸ë£¹ëª…} ê¸°ë„ì œëª©`;
      loading.style.display = "none";
      container.style.display = "block";

// âš¡ êµ¬ì„±ì› ëª©ë¡ì€ ì‹œíŠ¸ ì¹¼ëŸ¼ ëŒ€ì‹  ì „ì²´ ê¸°ë„ì œëª©ì—ì„œ ì§ì ‘ ì¶”ì¶œ (ìµœê³  ì•ˆì • ë°©ì‹)
// MODIFIED: êµ¬ì„±ì› ëª©ë¡ì„ ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
let members = [];
try {
  const res = await fetch(`${scriptURL}?mode=getGroupById&groupId=${groupId}`);
  const json = await res.json();
  members = json.group?.êµ¬ì„±ì›ëª©ë¡ || [];
} catch (e) {
  console.warn("â— êµ¬ì„±ì› ëª©ë¡ ìƒì„± ì˜¤ë¥˜:", e);
  members = [];
}

console.log("ğŸ” ìµœì¢… members:", members);

      renderMembers(members, group.ê·¸ë£¹ID, group.ê·¸ë£¹ëª…);
    }

// MODIFIED: ë©¤ë²„ ì¶”ê°€ í›„ í™”ë©´ì„ ì¦‰ì‹œ ë‹¤ì‹œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
async function refreshMembersAfterAdd() {
  console.log("ğŸ”„ [UI] ë©¤ë²„ ì¶”ê°€ í›„ ì¦‰ì‹œ ë©¤ë²„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘");

  try {
    // 1) ê·¸ë£¹ì •ë³´ ì‹œíŠ¸ì—ì„œ êµ¬ì„±ì› ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
    const res = await fetch(`${scriptURL}?mode=getGroupById&groupId=${groupId}`);
    const json = await res.json();

    if (!json.group) {
      console.error("âŒ ìƒˆ ë©¤ë²„ ë°˜ì˜ ì‹¤íŒ¨: ê·¸ë£¹ ì •ë³´ ì—†ìŒ");
      return;
    }

    const group = json.group;
    const members = group.êµ¬ì„±ì›ëª©ë¡;

    console.log("ğŸ†• [UI] ìƒˆë¡œ ì—…ë°ì´íŠ¸ëœ ë©¤ë²„ ëª©ë¡:", members);

    // 2) ì¦‰ì‹œ ë¦¬ë Œë”ë§
    renderMembers(members, groupId, group.ê·¸ë£¹ëª…);

  } catch (err) {
    console.error("âŒ refreshMembersAfterAdd() ì˜¤ë¥˜:", err);
    alert("ë©¤ë²„ëŠ” ì¶”ê°€ë˜ì—ˆì§€ë§Œ, í™”ë©´ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

// âœ… ê·¸ë£¹ ì „ì²´ ê¸°ë„ì œëª© í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
async function loadAllPrayers(groupId) {
  const res = await fetch(`${scriptURL}?mode=getPrayersAll&groupId=${groupId}`);
  return await res.json(); // [{ë©¤ë²„ì´ë¦„, prayers, ì‘ì„±ì‹œê°„}, ...]
}

// âœ… ê¸°ë„ì œëª© ì…ë ¥ì¹¸ ì¶”ê°€ í•¨ìˆ˜ (ë°˜ë“œì‹œ ì „ì—­ì— ì¶”ê°€)
function addPrayerField(container) {
  const wrapper = document.createElement("div");
  wrapper.className = "prayer-item";

  const index = container.querySelectorAll(".prayer-item").length + 1;

  // ë²ˆí˜¸
  const num = document.createElement("span");
  num.className = "prayer-number";
  num.textContent = `${index}.`;

  // ì…ë ¥ì¹¸
  const textarea = document.createElement("textarea");
  textarea.className = "prayer-textarea";
  textarea.rows = 1;
  textarea.placeholder = "ê¸°ë„ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...";

  // ë†’ì´ ìë™ ì¡°ì • (2ì¤„ ì´ìƒë„ ìì—°ìŠ¤ëŸ½ê²Œ)
  const autoResize = () => {
    textarea.style.height = "auto";
    const newHeight = Math.min(textarea.scrollHeight, 160);
    textarea.style.height = newHeight + "px";
  };
  textarea.addEventListener("input", () => {
    autoResize();
    textarea.closest(".member-section").querySelector(".save-btn").disabled = false;
  });
  setTimeout(autoResize, 0);

  // ì‚­ì œ ë²„íŠ¼
  const del = document.createElement("button");
  del.className = "delete-btn";
  del.textContent ="â€“"// "\u2296"; // âŠ– (ì› ì•ˆì˜ ë§ˆì´ë„ˆìŠ¤)
  del.onclick = () => {
    wrapper.remove();
    const items = container.querySelectorAll(".prayer-item");
    items.forEach((el, i) => el.querySelector(".prayer-number").textContent = `${i + 1}.`);
    container.closest(".member-section").querySelector(".save-btn").disabled = false;
  };

  wrapper.append(num, textarea, del);
  container.appendChild(wrapper);

  // í•­ìƒ âŒ í‘œì‹œë˜ê²Œ
  del.style.display = "block";
  return textarea;
}

async function renderMembers(members, groupId, groupName) {
  const container = document.getElementById("memberContainer");
  const loader = document.getElementById("loadingPrayers");
  container.innerHTML = "";
  loader.style.display = "flex";

  try {
    const allData = await loadAllPrayers(groupId);
    console.log("ğŸ“¦ [DEBUG] loadAllPrayers() ê²°ê³¼:", allData);

    if (!Array.isArray(allData)) throw new Error("ì„œë²„ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");

    const prayerMap = {};
    allData.forEach(p => (prayerMap[p.ë©¤ë²„ì´ë¦„] = p));

    const fragment = document.createDocumentFragment();

    for (const member of members) {
      const section = document.createElement("div");
      section.className = "member-section";

      // í—¤ë”
      const header = document.createElement("div");
      header.className = "member-header";
      header.innerHTML = `
        <div class="member-name"
     onmousedown="startRenamePress(event, '${member}')"     
     onmouseup="cancelRenamePress()"                           
     onmouseleave="cancelRenamePress()"                       
     ontouchstart="startRenamePress(event, '${member}')"       
     ontouchend="cancelRenamePress()">                         
  ${member}

  <button class="note-btn"
  onclick="location.href='note.html?groupId=${groupId}&groupName=${groupName}&member=${member}'"
  style="margin-left:8px; font-size:18px; background:none; border:none; cursor:pointer;">
  ğŸ“
</button>

</div>
<!-- // MODIFIED: ë¡±í”„ë ˆìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€ -->

        <button id="save-${member}" class="save-btn" disabled
          onclick="savePrayer('${groupId}','${member}', this, '${groupName}')">ìˆ˜ì •</button>
      `;

      const prayerContainer = document.createElement("div");
      prayerContainer.className = "prayer-container";

      const data = prayerMap[member];
      const prayers = [];

      console.log(`ğŸ§© [${member}] ì›ì‹œë°ì´í„°:`, data);

      if (data) {
        if (Array.isArray(data.prayers)) {
          console.log(`ğŸ§® [${member}] prayers ë°°ì—´ ê°ì§€ (${data.prayers.length}ê°œ):`, data.prayers);
          prayers.push(...data.prayers.filter(p => p && p.trim() !== ""));
        } else {
          for (let i = 1; i <= 6; i++) {
            const key = `ê¸°ë„ì œëª©${i}`;
            if (data[key] && data[key].trim() !== "") prayers.push(data[key]);
          }
          if (prayers.length === 0 && data.ê¸°ë„ì œëª©) prayers.push(data.ê¸°ë„ì œëª©);
          console.log(`ğŸ“‹ [${member}] êµ¬ë²„ì „ í•„ë“œ ìŠ¤ìº” ê²°ê³¼ (${prayers.length}ê°œ):`, prayers);
        }
      } else {
        console.warn(`âš ï¸ [${member}] ë°ì´í„° ì—†ìŒ`);
      }

      // âœ… textarea ìƒì„±
      if (prayers.length > 0) {
        prayers.forEach(text => {
          const t = addPrayerField(prayerContainer);
          t.value = text;
          t.style.height = "auto";
          t.style.height = t.scrollHeight + "px";
        });
      } else {
        addPrayerField(prayerContainer);
      }

      // ì¶”ê°€ ë²„íŠ¼
      const addBtn = document.createElement("button");
      addBtn.className = "add-btn";
      addBtn.textContent = "  â•  ";
      addBtn.onclick = () => addPrayerField(prayerContainer);

      // íƒ€ì„ìŠ¤íƒ¬í”„
      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.id = `time-${member}`;
      timestamp.textContent = data?.ì‘ì„±ì‹œê°„ ? timeAgo(data.ì‘ì„±ì‹œê°„) : "ì‘ì„± ì „";

      const bottomRow = document.createElement("div");
bottomRow.className = "bottom-row";
bottomRow.append(addBtn, timestamp);

section.append(header, prayerContainer, bottomRow);
      fragment.appendChild(section);

      console.log(`âœ… [${member}] ë Œë” ì™„ë£Œ (${prayers.length}ê°œ ê¸°ë„ì œëª©)`);
    }

    container.appendChild(fragment);
    console.log(`ğŸ¯ ì „ì²´ ë Œë” ì™„ë£Œ (${members.length}ëª…)`);
  } catch (err) {
    console.error("âŒ ì „ì²´ ê¸°ë„ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
    container.innerHTML = `<p style="color:#ff8080">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}</p>`;
  } finally {
    loader.style.display = "none";
  }
}

    // âœ… ìµœê·¼ ê¸°ë„ì œëª© ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadRecentPrayer(groupId, member, textarea) {
      try {
        const res = await fetch(`${scriptURL}?mode=getPrayers&groupId=${encodeURIComponent(groupId)}&member=${encodeURIComponent(member)}`);
        const data = await res.json();
        if (data && (data.prayers || data.prayer)) {
          const prayerText = Array.isArray(data.prayers)
            ? data.prayers.filter(p => p && p.trim() !== "").join("\n")
            : data.prayer || "";
          textarea.value = prayerText;
          document.getElementById(`time-${member}`).textContent = timeAgo(data.time);
          setTimeout(() => adjustHeight(textarea), 0);
        }
      } catch (err) {
        console.error("ê¸°ë„ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
      }

      setTimeout(() => {
        document.querySelectorAll("textarea").forEach(el => {
          el.style.height = "auto";
          el.style.height = el.scrollHeight + 8 + "px";
        });
      }, 600);
    }

    // âœ… ê¸°ë„ì œëª© ì €ì¥
    async function savePrayer(groupId, member, btn, groupName) {
  btn.textContent = "ì €ì¥ ì¤‘...";
  btn.disabled = true;

  // ğŸ” ì´ ë©¤ë²„ ì„¹ì…˜ ì°¾ê¸°
  const section = btn.closest(".member-section");
  const textareas = section.querySelectorAll(".prayer-textarea");

  // ğŸ” textarea ê°’ ìˆ˜ì§‘
  const prayers = [...textareas]
    .map(t => t.value.trim())
    .filter(t => t.length > 0);

  if (prayers.length === 0) {
    alert("ğŸ™ ìµœì†Œ 1ê°œ ì´ìƒì˜ ê¸°ë„ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");
    btn.textContent = "ì €ì¥";
    btn.disabled = false;
    return;
  }

  const payload = {
    mode: "savePrayer",
    groupId,
    groupName,
    member,
    prayers
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const json = await res.json();
    console.log("ğŸ’¾ ì €ì¥ê²°ê³¼:", json);

    if (!json.success) {
      alert("âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + json.message);
      btn.textContent = "ì €ì¥";
      btn.disabled = false;
      return;
    }

    // â­ ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
    btn.textContent = "ì €ì¥ë¨ âœ“";
    btn.style.background = "#4ade80";

    setTimeout(() => {
      btn.textContent = "ì €ì¥";
      btn.style.background = "";
      btn.disabled = false;
    }, 1500);

  } catch (err) {
    console.error("âŒ ì €ì¥ì˜¤ë¥˜:", err);
    btn.textContent = "ì €ì¥ ì‹¤íŒ¨";
    btn.disabled = false;
  }
}


    // âœ… textarea ë†’ì´ ìë™ ì¡°ì •
    function adjustHeight(el) {
      if (!el) return;
      el.style.height = "auto";
      el.style.height = Math.max(el.scrollHeight + 8, 60) + "px";
    }

    // âœ… ì‹œê°„ ë³€í™˜
    function timeAgo(isoTime) {
	  if (!isoTime) return "ì‘ì„±ì‹œê°„ ì—†ìŒ";

	  console.log("ğŸ•’ [timeAgo] ì…ë ¥ê°’:", isoTime);

	  // âœ… ê³µë°±ê³¼ ì  ì²˜ë¦¬ í†µì¼
	  const clean = isoTime.replace(/\s+/g, " ").replace(/\. /g, ".").trim();
	  console.log("ğŸ§¹ [timeAgo] ì •ë¦¬ëœ ë¬¸ìì—´:", clean);

	  let past = new Date(clean);
	  console.log("ğŸ“… [timeAgo] 1ì°¨ Date íŒŒì‹±:", past, " â†’ ìœ íš¨?", !isNaN(past));

	  // âœ… "2025.11.09 PM 4:33:39" / "2025. 9. 15. ì˜¤í›„ 9:11:51" ëŒ€ì‘
	  if (isNaN(past)) {
		const parsed = clean.match(
		  /(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})\.?\s*(?:ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)?\s*(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?\s*(ì˜¤ì „|ì˜¤í›„|AM|PM|am|pm)?/
		);
		console.log("ğŸ” [timeAgo] ì •ê·œì‹ ë§¤ì¹­:", parsed);

		if (parsed) {
		  // âœ… ì˜¤ì „/ì˜¤í›„ ìœ„ì¹˜ê°€ ì•ë’¤ë¡œ ì™€ë„ ëª¨ë‘ ì¸ì‹
		  let [_, y, m, d, h, min, s = "00", ampm] = parsed;
		  h = parseInt(h, 10);
		  const all = parsed.join(" ");

		  const hasPM = /PM|pm|ì˜¤í›„/.test(all);
		  const hasAM = /AM|am|ì˜¤ì „/.test(all);

		  if (hasPM && h < 12) h += 12;
		  if (hasAM && h === 12) h = 0;

		  const formatted = `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(
			2,
			"0"
		  )}T${String(h).padStart(2, "0")}:${String(min).padStart(2, "0")}:${String(
			s
		  ).padStart(2, "0")}`;

		  console.log("ğŸ§© [timeAgo] ì¬ì¡°í•©ëœ ë‚ ì§œ ë¬¸ìì—´:", formatted);
		  past = new Date(formatted);
		  console.log("ğŸ“… [timeAgo] 2ì°¨ Date íŒŒì‹±:", past, " â†’ ìœ íš¨?", !isNaN(past));
		}
	  }

	  if (isNaN(past)) {
		console.warn("âš ï¸ [timeAgo] ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì…ë‹ˆë‹¤:", isoTime);
		return "ì‹œê°„ ì˜¤ë¥˜";
	  }

	  const diff = (Date.now() - past) / 1000;
	  if (diff < 60) return "ë°©ê¸ˆ ì „";
	  if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
	  if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
	  if (diff < 2592000) return `${Math.floor(diff / 86400)}ì¼ ì „`;
	  return `${Math.floor(diff / 2592000)}ë‹¬ ì „`;
	}


    // âœ… í™ˆ ë²„íŠ¼
    function goHome() {
      const adminId = localStorage.getItem("adminId");
      if (!adminId) return (window.location.href = "index.html");
      window.location.href = "index.html?fromRecord=1";
    }

    // âœ… ê³µìœ  ë²„íŠ¼
    function shareGroup() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: document.getElementById("title").textContent,
          text: "ê¸°ë„ì œëª© í˜ì´ì§€ë¥¼ í•¨ê»˜ ë³´ì„¸ìš”",
          url,
        });
      } else {
        navigator.clipboard.writeText(url);
        alert("ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      }
    }

    // âœ… ì‘ë‹µë…¸íŠ¸ ëª¨ë‹¬
    async function showPrayerNote(member, groupId) {
      const modal = document.getElementById("responseModal");
      const list = document.getElementById("prayerList");
      modal.style.display = "flex";
      list.innerHTML = `<p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;

      try {
        const res = await fetch(`${scriptURL}?mode=getPrayersAll&groupId=${groupId}`);
        const prayers = await res.json();
        const items = prayers.filter(p => p.ë©¤ë²„ì´ë¦„ === member);
        if (items.length === 0) {
          list.innerHTML = `<p>ê¸°ë„ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        list.innerHTML = "";
        items.forEach(item => {
          const lines = (item.ê¸°ë„ì œëª© || "")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l !== "");

          lines.forEach((line, i) => {
            const div = document.createElement("div");
            div.className = "prayer-item";
            const textWithNumber = /^\d+\./.test(line)
              ? line
              : `${i + 1}. ${line}`;
            div.innerHTML = `
              <div class="prayer-text">ğŸ•Šï¸ ${textWithNumber}</div>
              <div class="prayer-buttons">
                <button class="btn-yes" onclick="setResponse(this, '${member}', '${line}', 'ì‘ë‹µë¨')">ì‘ë‹µë¨</button>
                <button class="btn-diff" onclick="setResponse(this, '${member}', '${line}', 'ë‹¤ë¥¸ ë°©í–¥')">ë‹¤ë¥¸ ë°©í–¥</button>
                <button class="btn-wait" onclick="setResponse(this, '${member}', '${line}', 'ëŒ€ê¸°ì¤‘')">ëŒ€ê¸°ì¤‘</button>
                <button class="btn-no" onclick="setResponse(this, '${member}', '${line}', 'ê±°ì ˆ')">ê±°ì ˆ</button>
              </div>
            `;
            list.appendChild(div);
          });
        });
      } catch (err) {
        list.innerHTML = `<p>âŒ ì˜¤ë¥˜: ${err.message}</p>`;
      }
    }

    function closeResponseModal() {
      document.getElementById("responseModal").style.display = "none";
    }

    async function setResponse(btn, member, prayer, status) {
      const parent = btn.closest(".prayer-item");
      parent.querySelector(".prayer-buttons").style.display = "none";
      const result = document.createElement("div");
      result.className = "result";
      result.innerHTML = `âœ… ${status} <button class="btn-edit" onclick="editResponse(this)">ìˆ˜ì •</button>`;
      parent.appendChild(result);

      const payload = { mode: "saveNote", groupId, member, prayer, status, privacy: "ê³µê°œ" };
      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        console.log("ì €ì¥ê²°ê³¼:", await res.json());
      } catch (err) {
        console.error("ì €ì¥ì˜¤ë¥˜:", err);
      }
    }

    function editResponse(btn) {
      const parent = btn.closest(".prayer-item");
      parent.querySelector(".result").remove();
      parent.querySelector(".prayer-buttons").style.display = "flex";
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.addEventListener("load", loadGroupMembers);
	
	/* -------------------------------------------------------------------------- */
/* ğŸŸ¦ ë©¤ë²„ ì¶”ê°€ UI ë™ì‘ */
/* -------------------------------------------------------------------------- */

document.getElementById("openAddMemberBtn").onclick = () => {
  console.log("ğŸŸ¦ [UI] ë©¤ë²„ ì¶”ê°€ í¼ ì—´ê¸°");
  document.getElementById("addMemberForm").style.display = "block";
  document.getElementById("openAddMemberBtn").style.display = "none";
};

document.getElementById("saveNewMemberBtn").onclick = async () => {
  const name = document.getElementById("newMemberName").value.trim();
  const btn = document.getElementById("saveNewMemberBtn");

  if (!name) {
    alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
    return;
  }

  /* ---------------------------
     ğŸ”¥ ì¶”ê°€ì¤‘... ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  ----------------------------*/
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "ì¶”ê°€ì¤‘...";

  const loader = document.createElement("span");
  loader.className = "member-add-loading";
  btn.appendChild(loader);

  console.log("ğŸ“¤ [ADD MEMBER] ìš”ì²­ ì‹œì‘ â†’", {
    groupId,
    newMember: name
  });

  const payload = {
    mode: "addMember",
    groupId: groupId,
    newMember: name
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const json = await res.json();

    console.log("ğŸ“¥ [ADD MEMBER] ì„œë²„ ì‘ë‹µ:", json);

    if (json.success) {
      alert(`ğŸ‰ ${name} ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);

      // ğŸ”„ ì¦‰ì‹œ ë°˜ì˜
      await refreshMembersAfterAdd();

      // ì…ë ¥ë°•ìŠ¤ ì´ˆê¸°í™”
      document.getElementById("newMemberName").value = "";
    } else {
      alert("ì¶”ê°€ ì‹¤íŒ¨: " + json.message);
    }

  } catch (err) {
    console.error("âŒ [ADD MEMBER] ì—ëŸ¬:", err);
    alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  } finally {
    /* ---------------------------
       ğŸ”¥ ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
    ----------------------------*/
    btn.disabled = false;
    btn.textContent = originalText;
    loader.remove();
  }
};

 
/* -------------------------------------------
   ğŸŸ¦ ì´ë¦„ ìˆ˜ì • ëª¨ë‹¬ ë™ì‘
------------------------------------------- */

let renameTarget = null;
let renameBox = null;   // â­ ì¶”ê°€


function openRenameModal(member) {
  renameTarget = member;
  document.getElementById("renameInput").value = member;

  const modal = document.getElementById("renameModal");
  modal.style.display = "flex";
}

function closeRenameModal() {
  renameTarget = null;
  document.getElementById("renameModal").style.display = "none";
}

async function saveRename() {
  if (!renameTarget) return;


  // â­ ë²„íŠ¼ â†’ "ìˆ˜ì •ì¤‘â€¦" ë¡œ ë³€ê²½
  const btn = document.getElementById("renameSaveBtn");
  btn.textContent = "ìˆ˜ì •ì¤‘â€¦";
  btn.disabled = true;

  // ë¡œë” íš¨ê³¼
  btn.classList.add("loading");
  
  const newName = document.getElementById("renameInput").value.trim();
  if (!newName) {
    alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
    return;
  }

  const payload = {
    mode: "renameMember",
    groupId,
    oldName: renameTarget,
    newName
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (json.success) {
      alert("ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");

      // ğŸ”„ ë³€ê²½ ì¦‰ì‹œ í™”ë©´ ë¦¬í”„ë ˆì‹œ
      await refreshMembersAfterAdd();
    } else {
      alert("ìˆ˜ì • ì‹¤íŒ¨: " + json.message);
    }

  } catch (err) {
    console.error("âŒ renameMember ì˜¤ë¥˜:", err);
    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }

  closeRenameModal();
}

/* ---------------------------------------------------------------------
   âœ¨ ë¹›ì…ì(ë¨¼ì§€) + ì‹­ìê°€ ë°˜ì§ì„ íš¨ê³¼ Canvas
--------------------------------------------------------------------- */
const canvas = document.getElementById("particleCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
const crosses = [];
const PARTICLE_COUNT = 30;   // ë¨¼ì§€ ê°œìˆ˜
const CROSS_COUNT = 6;       // ì‹­ìê°€ ê°œìˆ˜

/* Resize ëŒ€ì‘ */
window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

/* âœ¨ ì¼ë°˜ ë¨¼ì§€ì…ì ë§Œë“¤ê¸° */
class Dust {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.speedY = Math.random() * 0.4 + 0.1;
    this.alpha = Math.random() * 0.7 + 0.2;
    this.alphaChange = (Math.random() * 0.015 + 0.003) * (Math.random() > 0.5 ? -1 : 1);
  }
  update() {
    this.y += this.speedY;
    this.alpha += this.alphaChange;
    if (this.alpha <= 0.1 || this.alpha >= 0.8) this.alphaChange *= -1;
    if (this.y > canvas.height) this.reset();
  }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

/* âœ ë°ê¸° ê¹œë¹¡ì´ëŠ” ì‹­ìê°€ */
class Cross {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 8 + 4;
    this.alpha = Math.random() * 0.4 + 0.2;
    this.alphaChange = (Math.random() * 0.015 + 0.004) * (Math.random() > 0.5 ? -1 : 1);
  }
  update() {
    this.alpha += this.alphaChange;
    if (this.alpha <= 0.1 || this.alpha >= 0.9) this.alphaChange *= -1;
  }
  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.globalAlpha = this.alpha;
    ctx.strokeStyle = "white";
    ctx.lineWidth = 1.3;

    // ê°€ë¡œì„ 
    ctx.beginPath();
    ctx.moveTo(-this.size, 0);
    ctx.lineTo(this.size, 0);
    ctx.stroke();

    // ì„¸ë¡œì„ 
    ctx.beginPath();
    ctx.moveTo(0, -this.size);
    ctx.lineTo(0, this.size);
    ctx.stroke();

    ctx.restore();
  }
}

/* ì´ˆê¸° ìƒì„± */
for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(new Dust());
for (let i = 0; i < CROSS_COUNT; i++) crosses.push(new Cross());

/* âœ¨ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ */
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  particles.forEach(p => { p.update(); p.draw(); });
  crosses.forEach(c => { c.update(); c.draw(); });

  requestAnimationFrame(animate);
}

animate();

async function addVisitLog_Record() {
  try {
    const url = new URL(location.href);
    const groupId = url.searchParams.get("gid") || "";
    const from = url.searchParams.get("from") || "direct";

    const device = navigator.userAgent.includes("Mobile") ? "mobile" : "pc";
    const browser = navigator.userAgent;

    const adminId = localStorage.getItem("loginId") || "";

    await fetch(CONFIG.GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "addLog",
        page: "record",
        adminId,
        groupId,
        member: "",
        from,
        device,
        browser
      })
    });
  } catch (e) {
    console.warn("âŒ record ë¡œê·¸ ì‹¤íŒ¨:", e);
  }
}

window.addEventListener("beforeunload", () => {
  const stay = Math.floor((Date.now() - enterTime) / 1000);

  fetch(CONFIG.GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "logStay",
      page: "record",
      groupId: new URLSearchParams(window.location.search).get("gid"),
      time: new Date().toISOString(),
      stay: stay
    })
  });
});
async function signup() {
  const id = signupId.value.trim();
    const pwd = signupPwd.value.trim();
	  const pwd2 = signupPwd2.value.trim();
	    const email = signupEmail.value.trim();
		  const msg = signupMsg;
		  
		    msg.textContent = "";
			
			  if (id.length < 4 || pwd.length < 4) {
			      msg.textContent = "âš ï¸ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ì´ìƒì…ë‹ˆë‹¤.";
				      return;
					    }
						
						  if (pwd !== pwd2) {
						      msg.textContent = "âš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
							      return;
								    }
									
									  if (!email) {
									      msg.textContent = "âš ï¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
										      return;
											    }
												
												  try {
												      const res = await fetch(`${scriptURL}?mode=signup&id=${id}&pwd=${pwd}&email=${email}`);
													      const data = await res.json();
														  
														      if (data.success) {
															        msg.style.color = "#9fff9f";
																	      msg.textContent = "ğŸ‰ íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
																		      } else {
																			        msg.style.color = "#ffcccb";
																					      msg.textContent = "âŒ " + data.message;
																						      }
																							  
																							    } catch (err) {
																								    msg.style.color = "#ffcccb";
																									    msg.textContent = "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
																										  }
																										  }
																										  
// í˜ì´ì§€ ë¡œë“œ ì§í›„ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", addVisitLog_Record);

/* ----------------------------- */
/* ğŸ”” ì•Œë¦¼ ì„¤ì • í† ê¸€ ë²„íŠ¼       */
/* ----------------------------- */

document.getElementById("notifyBtn").addEventListener("click", toggleSub);

async function toggleSub() {
  const isSub = localStorage.getItem("push_sub_" + groupId) === "1";

  if (!isSub) {
    await subscribeToPush(groupId);
    showToast("ğŸ”” ì•Œë¦¼ ì„¤ì •ë¨");
    localStorage.setItem("push_sub_" + groupId, "1");
    document.getElementById("notifyBtn").innerText = "ğŸ”• ì•Œë¦¼ í•´ì œ";
  } else {
    await unsubscribePush(groupId);
    showToast("ì•Œë¦¼ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤");
    localStorage.removeItem("push_sub_" + groupId);
    document.getElementById("notifyBtn").innerText = "ğŸ”” ì•Œë¦¼ ì„¤ì •";
  }
}

</script>

 <!-- âœ… ì‘ë‹µ ë…¸íŠ¸ ëª¨ë‹¬ -->
  <div id="responseModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="responseTitle">ğŸ™ ì‘ë‹µ ê¸°ë¡</h3>
      <div id="prayerList"></div>
      <div style="text-align:center; margin-top:15px;">
        <button onclick="closeResponseModal()" class="btn-close">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
  
  
</body>
</html>
